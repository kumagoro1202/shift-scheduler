# シフト作成プログラム - 実装計画（小規模施設版）

## 対象

- **施設規模**: 5名程度の職員
- **動作環境**: ローカルPC（サーバー不要）
- **機能範囲**: 最小限の必須機能のみ

## 実装フェーズ概要

全体を3つのフェーズに分けて段階的に実装します。各フェーズは1週間を想定しています。

## Phase 1: 基盤構築とデータ管理 (Week 1)

### 1.1 プロジェクト構築
- [ ] Pythonプロジェクト作成
- [ ] 依存パッケージ管理（requirements.txt）
- [ ] フォルダ構造の作成

### 1.2 データベース構築
- [ ] SQLite接続設定
- [ ] テーブル作成スクリプト
  - employees（職員）
  - time_slots（時間帯）
  - shifts（シフト）
  - availability（勤務可能情報）
  - settings（設定）
- [ ] 初期データ投入スクリプト

### 1.3 Streamlit基礎
- [ ] Streamlitアプリ初期化
- [ ] マルチページ構成の設定
- [ ] ホーム画面の作成
- [ ] ナビゲーションメニュー

### 1.4 基本CRUD機能
**職員管理:**
- [ ] 職員一覧表示
- [ ] 職員追加フォーム
- [ ] 職員編集機能
- [ ] 職員削除機能
- [ ] スキルスコア入力（1-100）

**時間帯管理:**
- [ ] 時間帯一覧表示
- [ ] 時間帯追加フォーム
- [ ] 時間帯編集・削除

### 成果物
- 動作するStreamlitアプリ
- SQLiteデータベース
- 職員・時間帯の管理機能

---

## Phase 2: 最適化エンジンとシフト生成 (Week 2)

### 2.1 勤務可能情報管理
- [ ] カレンダー形式の入力UI
- [ ] 職員別の可能情報登録
- [ ] 月単位での表示・編集
- [ ] 一括設定機能（全員可能など）

### 2.2 最適化エンジン実装
- [ ] PuLP インストールと設定
- [ ] 最適化アルゴリズム実装
  - 目的関数: スキルスコア均等化
  - 制約1: 必要人数
  - 制約2: 勤務可能時間
  - 制約3: 1人1日1シフト
- [ ] ソルバー実行処理
- [ ] 最適化失敗時の処理

### 2.3 シフト生成UI
- [ ] 生成パラメータ設定画面
  - 対象期間選択（開始日・終了日）
  - 目標平均スキルスコア
- [ ] 生成実行ボタン
- [ ] 進捗表示
- [ ] 生成結果のプレビュー

### 2.4 テスト
- [ ] 5名のサンプルデータでテスト
- [ ] 1ヶ月分のシフト生成テスト
- [ ] 制約違反チェック

### 成果物
- 動作する最適化エンジン
- シフト自動生成機能
- 勤務可能情報管理

---

## Phase 3: シフト表示・編集と仕上げ (Week 3)

### 3.1 シフト表示機能
- [ ] 月別カレンダー表示
- [ ] 日別ビュー
- [ ] 時間帯ごとのスキルスコア表示
- [ ] スキル分布グラフ（plotly）

### 3.2 シフト編集機能
- [ ] 手動での職員変更
- [ ] シフト追加・削除
- [ ] スキルスコアのリアルタイム計算
- [ ] 制約違反の警告表示

### 3.3 データ出力機能
- [ ] Excel形式でエクスポート
- [ ] 印刷レイアウト
- [ ] 月別シフト表

### 3.4 ダッシュボード
- [ ] 今月のシフト概要
- [ ] 職員別勤務日数
- [ ] 時間帯別平均スキルスコア
- [ ] グラフ表示

### 3.5 仕上げ
- [ ] エラーハンドリング
- [ ] ユーザーメッセージの改善
- [ ] ヘルプ・使い方ガイド
- [ ] データバックアップ機能
- [ ] 設定画面（基本設定）

### 3.6 実行ファイル化
- [ ] PyInstallerの設定
- [ ] .exeファイルの作成（Windows）
- [ ] 動作確認
- [ ] 配布パッケージ作成

### 成果物
- 完成したシフト管理アプリ
- 実行ファイル（.exe）
- ユーザーマニュアル

---

## プロジェクト構造

```
shift_app/
├── main.py                 # メインエントリーポイント
├── requirements.txt        # 依存パッケージ
├── pages/                  # Streamlitページ
│   ├── 1_👥_職員管理.py
│   ├── 2_⏰_時間帯設定.py
│   ├── 3_📅_勤務可能情報.py
│   ├── 4_🎯_シフト生成.py
│   └── 5_📋_シフト表示.py
├── src/
│   ├── database.py         # DB接続・操作
│   ├── models.py           # データモデル
│   ├── optimizer.py        # 最適化エンジン
│   └── utils.py            # ユーティリティ
├── data/
│   └── shift.db           # SQLiteデータベース
├── exports/               # Excel出力先
└── docs/
    └── manual.md          # ユーザーマニュアル
```

---

## 技術的な優先順位

### 高優先度（必須）
1. ✅ SQLiteデータベース構築
2. ✅ 職員・時間帯管理
3. ✅ 最適化エンジンのコア実装
4. ✅ シフト生成機能

### 中優先度（重要）
1. 勤務可能情報入力
2. シフト表示UI
3. 手動編集機能
4. Excel出力

### 低優先度（あれば良い）
1. 高度な分析機能
2. グラフ表示
3. バックアップ機能

---

## 開発環境

### 必要なソフトウェア
- Python 3.11以上
- pip（パッケージ管理）
- テキストエディタ（VS Code推奨）

### 依存パッケージ（requirements.txt）

```txt
streamlit==1.28.0
pandas==2.1.0
pulp==2.7.0
openpyxl==3.1.0
plotly==5.17.0
python-dateutil==2.8.2
```

---

## マイルストーン

| マイルストーン | 期限 | 成果物 |
|--------------|------|--------|
| M1: 基盤完成 | Week 1 | データ管理機能 |
| M2: 最適化完成 | Week 2 | シフト自動生成 |
| M3: リリース準備完了 | Week 3 | 実行ファイル完成 |

---

## リスクと対策

### リスク1: 最適化が収束しない
**対策:**
- 制約を最小限に（5名なら問題なし）
- タイムアウト設定（60秒）

### リスク2: UI使いにくい
**対策:**
- 直感的な画面設計
- 豊富なサンプルデータ
- ヘルプガイド充実

### リスク3: データ消失
**対策:**
- 定期的なバックアップ推奨
- データエクスポート機能

---

## 開発体制（推奨）

### 最小構成
- **開発者**: 1名
- **期間**: 3週間（21日間）
- **工数**: 約60-80時間

---

## 次のアクション

### 即座に開始可能なタスク
1. **Python環境のセットアップ**
2. **Streamlitのインストールと動作確認**
3. **SQLiteデータベースのテーブル設計**
4. **簡単なUI画面のプロトタイプ**

### Week 1 の詳細タスク（5日間）

**Day 1-2: 環境構築**
- Pythonプロジェクト作成
- 依存パッケージインストール
- SQLiteデータベース作成
- Streamlitホーム画面

**Day 3-4: 職員管理**
- 職員テーブルCRUD
- 職員管理画面
- スキルスコア入力

**Day 5: 時間帯管理**
- 時間帯テーブルCRUD
- 時間帯管理画面
- データ確認

---

## MVPスコープ（最小限版 - 2週間）

さらに短期間で試したい場合:

### 含む機能
1. 職員管理（名前、スキルスコアのみ）
2. 固定の3つの時間帯（午前・午後・夜）
3. シンプルな最適化（必要人数2名固定）
4. カレンダー表示のみ（編集なし）

### 除外する機能
- 勤務可能情報（全員常に可能と仮定）
- 手動編集
- Excel出力
- グラフ・分析

このMVPで概念実証を行い、フィードバックを得てから本格実装に進むことも可能です。

### 1.1 開発環境のセットアップ
- [ ] プロジェクト構造の作成
- [ ] Docker環境の構築
  - PostgreSQL コンテナ
  - Redis コンテナ
  - Backend コンテナ
  - Frontend コンテナ
- [ ] Docker Compose 設定

### 1.2 バックエンド基礎
- [ ] Poetry による依存管理設定
- [ ] FastAPI プロジェクト初期化
- [ ] データベース接続設定（SQLAlchemy）
- [ ] Alembic マイグレーション設定
- [ ] 環境変数管理（.env）
- [ ] ロガー設定

### 1.3 データベーススキーマ
- [ ] Employee テーブル作成
- [ ] TimeSlot テーブル作成
- [ ] Shift テーブル作成
- [ ] ShiftAssignment テーブル作成
- [ ] EmployeeAvailability テーブル作成
- [ ] OptimizationConstraint テーブル作成
- [ ] インデックス設定

### 1.4 フロントエンド基礎
- [ ] Vite + React + TypeScript プロジェクト作成
- [ ] Tailwind CSS 設定
- [ ] shadcn/ui コンポーネントインストール
- [ ] ルーティング設定（React Router）
- [ ] API クライアント設定（Axios）
- [ ] 環境変数設定

### 成果物
- 開発環境一式
- データベーススキーマ
- 基本的なプロジェクト構造

---

## Phase 2: 基本CRUD機能実装 (Week 3-4)

### 2.1 認証システム
- [ ] JWT認証の実装
- [ ] ログイン/ログアウト API
- [ ] パスワードハッシュ化
- [ ] 認証ミドルウェア
- [ ] ロールベースアクセス制御

### 2.2 職員管理機能
**Backend:**
- [ ] Employee モデル（SQLAlchemy）
- [ ] Employee CRUD API
- [ ] バリデーション（Pydantic）
- [ ] ユニットテスト

**Frontend:**
- [ ] 職員一覧画面
- [ ] 職員登録フォーム
- [ ] 職員編集フォーム
- [ ] 職員削除機能
- [ ] スキルスコア入力UI

### 2.3 時間帯管理機能
**Backend:**
- [ ] TimeSlot モデル
- [ ] TimeSlot CRUD API
- [ ] テスト

**Frontend:**
- [ ] 時間帯設定画面
- [ ] 時間帯編集フォーム

### 2.4 勤務可能情報管理
**Backend:**
- [ ] EmployeeAvailability モデル
- [ ] Availability CRUD API
- [ ] 一括登録API

**Frontend:**
- [ ] カレンダー形式の可能情報入力UI
- [ ] 希望度レベル設定
- [ ] 一括コピー機能

### 成果物
- 認証システム
- 職員・時間帯・勤務可能情報の管理機能
- 基本的なUI

---

## Phase 3: シフト最適化エンジン実装 (Week 5-6)

### 3.1 最適化ライブラリの統合
- [ ] OR-Tools インストールと設定
- [ ] PuLP インストール（代替用）
- [ ] 最適化エンジンの基本構造

### 3.2 最適化アルゴリズム実装
- [ ] 制約条件の定義
  - 必要人数制約
  - 勤務可能時間制約
  - 週間最大勤務時間制約
  - 連続勤務日数制約
  - 勤務間インターバル制約
- [ ] 目的関数の実装（スキルスコア分散最小化）
- [ ] ソルバー実行処理
- [ ] 最適化失敗時のフォールバック処理

### 3.3 最適化エンジンのテスト
- [ ] 小規模データでのテスト
- [ ] 制約違反チェック
- [ ] パフォーマンステスト
- [ ] エッジケーステスト

### 3.4 シフト生成API
- [ ] シフト生成リクエスト受付API
- [ ] 非同期処理（Celery/BackgroundTasks）
- [ ] 生成状況確認API
- [ ] 生成結果取得API

### 成果物
- 動作するシフト最適化エンジン
- シフト自動生成API
- 最適化アルゴリズムのテストスイート

---

## Phase 4: シフト管理UI実装 (Week 7-8)

### 4.1 シフト表示機能
**Backend:**
- [ ] Shift モデル
- [ ] ShiftAssignment モデル
- [ ] シフト取得API（期間指定、フィルタ）
- [ ] スキルスコア集計API

**Frontend:**
- [ ] カレンダービュー（FullCalendar統合）
- [ ] 日別ビュー
- [ ] 週別ビュー
- [ ] 月別ビュー
- [ ] 時間帯ごとのスキルスコア表示
- [ ] スキル分布グラフ

### 4.2 シフト生成UI
- [ ] シフト生成パラメータ設定フォーム
- [ ] 期間選択
- [ ] 制約条件選択
- [ ] 生成実行ボタン
- [ ] 進捗表示
- [ ] 結果プレビュー

### 4.3 シフト編集機能
- [ ] ドラッグ&ドロップでの割当変更
- [ ] 手動での職員追加・削除
- [ ] 制約違反の警告表示
- [ ] スキルスコアのリアルタイム計算
- [ ] 変更の一時保存
- [ ] 変更の確定

### 4.4 シフト確定・公開機能
- [ ] シフト確定API
- [ ] シフト公開API
- [ ] 確定済みシフトのロック
- [ ] 公開通知（メール送信準備）

### 成果物
- 使いやすいシフト管理UI
- シフト編集機能
- シフト公開機能

---

## Phase 5: 分析機能と最終調整 (Week 9-10)

### 5.1 レポート・分析機能
**Backend:**
- [ ] スキル分布分析API
- [ ] シフトバランス分析API
- [ ] 職員別勤務時間集計API
- [ ] 時間帯別平均スキルスコアAPI
- [ ] 制約違反レポートAPI

**Frontend:**
- [ ] ダッシュボード画面
- [ ] スキル分布チャート
- [ ] シフトバランスグラフ
- [ ] 職員勤務時間レポート
- [ ] CSV/PDF エクスポート

### 5.2 制約条件管理UI
- [ ] 制約条件一覧画面
- [ ] 制約条件追加フォーム
- [ ] 制約条件の有効/無効切替
- [ ] カスタム制約のパラメータ設定

### 5.3 最適化の改善
- [ ] パラメータチューニング
- [ ] 計算時間の最適化
- [ ] ソリューションの品質向上
- [ ] 複数解の生成と比較

### 5.4 ユーザビリティ改善
- [ ] エラーメッセージの改善
- [ ] ローディング状態の表示
- [ ] トースト通知
- [ ] ヘルプ・ツールチップ
- [ ] レスポンシブ対応

### 5.5 テスト・品質保証
- [ ] E2Eテスト（Playwright）
- [ ] パフォーマンステスト
- [ ] セキュリティチェック
- [ ] アクセシビリティチェック
- [ ] ブラウザ互換性テスト

### 5.6 ドキュメント整備
- [ ] API仕様書（OpenAPI/Swagger）
- [ ] ユーザーマニュアル
- [ ] 管理者マニュアル
- [ ] デプロイ手順書
- [ ] トラブルシューティングガイド

### 成果物
- 分析・レポート機能
- 完全なテストスイート
- 本番環境へのデプロイ準備
- ドキュメント一式

---

## Phase 6: デプロイと運用準備 (Week 11-12)

### 6.1 本番環境構築
- [ ] クラウドインフラ選定（AWS/Azure/GCP）
- [ ] データベースセットアップ
- [ ] アプリケーションサーバー構築
- [ ] リバースプロキシ設定（Nginx）
- [ ] SSL証明書設定
- [ ] バックアップ設定

### 6.2 CI/CD パイプライン
- [ ] GitHub Actions ワークフロー
- [ ] 自動テスト実行
- [ ] 自動デプロイ設定
- [ ] ロールバック手順

### 6.3 監視・ログ設定
- [ ] アプリケーションログ
- [ ] エラートラッキング（Sentry等）
- [ ] パフォーマンス監視
- [ ] アラート設定

### 6.4 運用準備
- [ ] 初期データ投入
- [ ] ユーザートレーニング
- [ ] 運用マニュアル
- [ ] 障害対応手順

### 成果物
- 本番環境
- CI/CDパイプライン
- 監視体制
- 運用体制

---

## 技術的な優先順位

### 高優先度
1. データベース設計とマイグレーション
2. 最適化エンジンのコア実装
3. 基本的なCRUD API
4. シフト表示UI

### 中優先度
1. 認証・認可システム
2. 勤務可能情報入力UI
3. シフト編集機能
4. 基本的な分析機能

### 低優先度（後回し可能）
1. 高度な分析機能
2. CSV/PDFエクスポート
3. メール通知
4. モバイル対応

---

## リスクと対策

### リスク1: 最適化アルゴリズムが収束しない
**対策:**
- 制約を緩和するオプション実装
- タイムアウト設定
- ヒューリスティック手法の代替実装

### リスク2: パフォーマンス問題
**対策:**
- 早期のパフォーマンステスト
- 非同期処理の導入
- キャッシング戦略

### リスク3: 複雑な制約条件への対応
**対策:**
- 段階的な制約追加
- カスタマイズ可能な設計
- 柔軟な制約管理システム

### リスク4: ユーザビリティ
**対策:**
- 早期のプロトタイプレビュー
- ユーザーフィードバックの反映
- UIの反復改善

---

## 開発体制（推奨）

### 最小構成（1-2名）
- フルスタック開発者 × 1-2名
- 期間: 10-12週間

### 理想構成（3-4名）
- バックエンド開発者 × 1名
- フロントエンド開発者 × 1名
- 最適化アルゴリズムエンジニア × 1名
- UI/UXデザイナー × 1名（パート可）
- 期間: 8-10週間

---

## マイルストーン

| マイルストーン | 期限 | 成果物 |
|--------------|------|--------|
| M1: 環境構築完了 | Week 2 | 開発環境、DB設計 |
| M2: 基本機能完了 | Week 4 | CRUD API、基本UI |
| M3: 最適化エンジン完成 | Week 6 | シフト自動生成機能 |
| M4: UI完成 | Week 8 | シフト管理UI一式 |
| M5: 本番リリース準備完了 | Week 10 | 分析機能、テスト完了 |
| M6: 本番稼働開始 | Week 12 | デプロイ、運用開始 |

---

## 次のアクション

### 即座に開始可能なタスク
1. **プロジェクト構造の作成**
2. **Docker環境のセットアップ**
3. **データベース設計の詳細化**
4. **OR-Toolsの調査と小規模プロトタイプ**

### 要件定義が必要な項目
1. 具体的な制約条件の確定
2. 必要な時間帯の定義
3. 職員の雇用形態の詳細
4. レポート要件の詳細
5. 既存システムとの連携要件

---

## 補足: クイックスタートガイド

最小限の機能で早期に動作確認したい場合のMVP（Minimum Viable Product）:

### MVPスコープ（4週間）
1. 職員マスタ（名前、スキルスコアのみ）
2. シンプルな時間帯設定（1日3つの時間帯）
3. 基本的な最適化（必要人数とスキル平均化のみ）
4. シンプルなカレンダー表示
5. 手動編集なし（自動生成のみ）

このMVPで概念実証を行い、フィードバックを得てから本格実装に進むことも可能です。
