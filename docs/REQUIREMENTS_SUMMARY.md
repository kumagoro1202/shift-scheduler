# 要求事項サマリー - 追加仕様

**最終更新**: 2025年12月4日  
**対象**: シフト作成システム V3.0 追加要件

---

## 1. 主要な変更点

### 1.1 勤務形態の詳細化

従来の簡素化された勤務形態から、実際の運用に即した詳細な勤務パターンに変更:

#### 正職員の勤務パターン（曜日別）

**月火金**: 10時間拘束（A/B/C）
- A（早出）: 08:30-18:30（開院準備担当）
- B（通常）: 08:45-18:45（標準シフト）
- C（遅出）: 09:00-19:00（閉院・締め作業、残業確定）

**水曜**: 9時間拘束（◯/通常/△）
- ◯（早出）: 08:30-17:30
- 通常: 08:45-17:45
- △（遅出）: 09:00-18:00（午後診療後の残務、残業あり）

**木曜・土曜**: 4時間勤務（1/2/3）
- 1（早出）: 08:30-12:30
- 2（通常）: 08:45-12:45
- 3（遅出）: 09:00-13:00

#### 時短勤務（契約職員1名固定）

| 曜日 | 時間 | 休憩 |
|------|------|------|
| 月火水金 | 08:45-16:45 | 60分 |
| 木 | 08:45-12:45 | なし |
| 土 | 09:45-13:45 | なし |

**特徴**: 午後診療に入らない固定勤務

#### パート勤務

- **午前パート（PA）**: 08:45-12:45 または 09:00-13:00（4時間）
- **5時間非常勤（P3）**: 08:45-13:45（午後の一部対応可能）

---

## 2. 休憩時間管理の厳格化

### 2.1 基本ルール

| 勤務 | 拘束時間 | 通常休憩 | 実働 |
|------|---------|---------|------|
| 月火金 | 10時間 | 120分 | 8時間 |
| 水曜 | 9時間 | 120分 | 7時間 |
| 時短 | 8時間 | 60分 | 7時間 |
| 木土 | 4時間 | なし | 4時間 |

### 2.2 緊急時の休憩短縮

**発生条件**:
- 欠勤者が出た場合
- 受付窓口の最低2名を維持できない場合

**短縮ルール**:
- 120分休憩 → 60分休憩に短縮可能
- 短縮した60分は必ず残業として計上
- シフト表に「1時間休憩シフト」と明記

**目的**: サービス残業（休憩返上）の絶対的防止

### 2.3 残業計上

以下のケースで残業が発生:

1. **遅出シフト（C、△）**: 閉院作業・締め作業で残業確定
2. **休憩短縮**: 120分→60分短縮時に+60分残業
3. **緊急対応**: その他の予定外業務

---

## 3. 最適化目標の明確化

### 3.1 能力の平均化

**要求**: 「それぞれの時間の能力を平均化したい」

#### 実装方針

各時間帯（リハ室午前、受付午前、受付午後など）において:

1. **配置職員のスキル平均を計算**
   - リハ室: (リハ室スキル + 総合対応力) ÷ 配置人数
   - 受付午前: (受付午前スキル + 総合対応力) ÷ 配置人数
   - 受付午後: (受付午後スキル + 総合対応力) ÷ 配置人数

2. **目標値の設定**
   - 目標値 = 全職員の該当スキルの平均値

3. **最適化関数**
   ```
   最小化: Σ(各日の配置スキル平均 - 目標値)²
   ```

#### 効果

- 特定の日だけ優秀な職員が集中することを防止
- どの日でも同じレベルのサービス品質を提供
- スキルの高い職員への負担集中を防止

---

## 4. データモデルの拡張

### 4.1 employment_patterns テーブル

新規追加フィールド:

```sql
day_type TEXT NOT NULL,                    -- 曜日タイプ
pattern_symbol TEXT,                       -- 勤務パターン記号（A/B/C等）
can_reduce_break BOOLEAN DEFAULT 0,        -- 休憩短縮可能フラグ
reduced_break_hours REAL,                  -- 短縮後の休憩時間
overtime_for_reduction REAL,               -- 短縮時の残業計上時間
is_overtime_default BOOLEAN DEFAULT 0      -- デフォルト残業フラグ
```

### 4.2 shifts テーブル

新規追加フィールド:

```sql
employment_pattern_id TEXT,                -- その日の勤務形態
break_reduced BOOLEAN DEFAULT 0,           -- 休憩短縮フラグ
overtime_minutes INTEGER DEFAULT 0,        -- 残業時間（分）
overtime_reason TEXT                       -- 残業理由
```

---

## 5. 勤務表CSVの記号体系

### 5.1 記号と意味

| 記号 | 意味 | 勤務時間 | 適用曜日 |
|------|------|---------|---------|
| A | 早出 | 08:30-18:30 | 月火金 |
| B | 通常 | 08:45-18:45 | 月火金 |
| C | 遅出（残業確定） | 09:00-19:00 | 月火金 |
| ◯ | 早出 | 08:30-17:30 | 水 |
| 通常 | 通常 | 08:45-17:45 | 水 |
| △ | 遅出 | 09:00-18:00 | 水 |
| 1 | 早出 | 08:30-12:30 | 木土 |
| 2 | 通常 | 08:45-12:45 | 木土 |
| 3 | 遅出 | 09:00-13:00 | 木土 |
| PA | パート午前 | 08:45-12:45 or 09:00-13:00 | - |
| P3 | 5時間非常勤 | 08:45-13:45 | - |
| 月火 | 時短勤務 | 08:45-16:45 | 月火 |
| 早 | 時短勤務（早出） | 該当時刻 | - |
| 土曜 | 時短勤務（土） | 09:45-13:45 | 土 |
| 有休 | 有給休暇 | - | - |
| 休み | 休暇 | - | - |

### 5.2 CSVインポート機能（将来実装）

- CSV形式の勤務表を読み込み
- 記号を自動解釈してemployment_patternに割り当て
- 休暇情報を自動登録
- 既存データとの整合性チェック

---

## 6. 制約条件の追加

### 6.1 新規ハード制約

#### 休憩時間の労務管理

- 正職員は原則として規定の休憩時間（120分または60分）を取得
- 欠勤者発生時は休憩短縮（120分→60分）を許可
- 短縮分は必ず残業として計上
- **サービス残業（休憩返上）は絶対に発生させない**

### 6.2 既存制約の継承

- 休暇登録のある日は勤務させない
- 勤務形態で対応できない時間帯には配置しない
- 職員タイプで配置不可の業務エリアには配置しない
- 各時間帯の必要人数を満たす
- 終日勤務の原則（半休でない限り）

---

## 7. 実装の優先順位

### Phase 1: データモデルの拡張（最優先）

1. `employment_patterns` テーブルの拡張
2. `shifts` テーブルの拡張
3. 既存データのマイグレーション

### Phase 2: 勤務形態マスタの整備

1. 正職員の勤務パターン登録（A/B/C、◯/△、1/2/3）
2. 時短勤務パターンの登録
3. パート勤務パターンの登録

### Phase 3: 最適化ロジックの改修

1. 能力平均化アルゴリズムの実装
2. 休憩短縮ロジックの実装
3. 残業計上ロジックの実装

### Phase 4: UI/UX改善

1. 勤務パターン選択UIの改善
2. 残業時間の表示
3. 休憩短縮の警告表示

### Phase 5: CSV連携機能（将来）

1. CSVインポート機能
2. 記号の自動解釈
3. 一括登録機能

---

## 8. 注意事項

### 8.1 労務管理上の重要事項

- 休憩時間の適切な管理は労働基準法遵守の観点から極めて重要
- サービス残業は法令違反となるため、システムレベルで防止
- 残業時間は正確に記録し、給与計算に反映できるようにする

### 8.2 運用上の考慮事項

- 時短勤務職員（1名）は固定勤務のため柔軟性がない
- 5時間非常勤は13:45までのため、午後診療（15:30開始）には対応できない
- 遅出シフト（C、△）は残業が確定するため、連続配置を避けるべき

### 8.3 システム設計上の原則

- 勤務形態は曜日ごとに異なるため、`day_type` で厳密に管理
- 休憩短縮は例外的な対応であり、通常は発生しないことを前提とする
- スキル平均化は「完全な均一化」ではなく「バラツキの最小化」を目指す

---

**文書管理情報**
- バージョン: 3.1
- 作成日: 2025年12月4日
- 対象システム: シフト作成システム V3.0 追加仕様
- 関連文書: REQUIREMENTS.md V3.0
