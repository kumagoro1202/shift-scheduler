# シフト作成システム V2.0→V3.0 マイグレーションガイド

## 📋 目次

1. [概要](#概要)
2. [主な変更点](#主な変更点)
3. [マイグレーション前の準備](#マイグレーション前の準備)
4. [マイグレーション手順](#マイグレーション手順)
5. [マイグレーション後の確認](#マイグレーション後の確認)
6. [トラブルシューティング](#トラブルシューティング)

---

## 概要

V3.0では、システムの使いやすさと堅牢性を向上させるため、以下の大幅な改修を行いました：

- **休暇管理の簡素化**: 時間帯ごとの勤務可否登録から、日付単位の休暇登録に変更
- **診療時間の固定化**: 時間帯マスタを固定化し、運用を簡素化
- **勤務形態マスタの整備**: より柔軟な勤務形態管理が可能に

### 互換性について

- V3.0は**V2.0のデータを自動変換**します
- マイグレーション前に**自動バックアップ**が作成されます
- 問題が発生した場合は**バックアップからロールバック**可能です

---

## 主な変更点

### 1. データベーススキーマの変更

#### 新規テーブル

| テーブル名 | 説明 |
|-----------|------|
| `employment_patterns` | 勤務形態マスタ（フルタイム、時短、パートなど） |
| `employee_absences` | 休暇登録テーブル（終日休暇、午前休、午後休） |

#### 変更テーブル

| テーブル名 | 変更内容 |
|-----------|---------|
| `employees` | `employment_pattern_id` カラム追加 |
| `time_slots` | 固定データ化（編集不可） |

#### 廃止テーブル

| テーブル名 | 代替 |
|-----------|-----|
| `availability` | `employee_absences` に変換 |

### 2. UI/UX の変更

| 変更前 | 変更後 |
|-------|-------|
| 時間帯設定ページ | **廃止**（診療時間は固定） |
| 勤務可能情報ページ | **休暇管理ページ**に改名・機能変更 |
| 職員管理ページ | 勤務形態選択UIを改修 |

### 3. 診療スケジュール（固定）

| 曜日 | 午前 | 午後 |
|-----|------|------|
| 月 | 09:00-12:30 | 15:30-18:30 |
| 火 | 09:00-12:30 | 15:30-18:30 |
| 水 | 09:00-12:30 | 15:30-17:30 |
| 木 | 09:00-12:30 | 休診 |
| 金 | 09:00-12:30 | 15:30-18:30 |
| 土 | 09:00-13:30 | 休診 |
| 日 | 休診 | 休診 |

### 4. 勤務形態マスタ

| ID | 名称 | カテゴリ | 勤務時間 | 午後勤務 |
|----|------|---------|---------|---------|
| `full_early` | フルタイム（早番） | 正職員 | 08:30-18:30 | ✅ |
| `full_mid` | フルタイム（中番） | 正職員 | 08:45-18:45 | ✅ |
| `full_late` | フルタイム（遅番） | 正職員 | 09:00-19:00 | ✅ |
| `short_time` | 時短勤務 | 正職員 | 08:45-16:45 | ❌ |
| `part_morning` | パート午前 | パート | 08:45-12:45 | ❌ |
| `part_morning_ext` | パート午前延長 | パート | 08:45-13:45 | ❌ |

---

## マイグレーション前の準備

### 1. システム要件の確認

- Python 3.8以上
- 必要なパッケージがインストール済み
- 最新のコードに更新済み

### 2. データベースのバックアップ（推奨）

マイグレーションスクリプトは自動でバックアップを作成しますが、念のため手動バックアップも推奨します：

```powershell
# データフォルダ全体をバックアップ
Copy-Item -Recurse data data_backup_before_v3
```

### 3. 現在のデータの確認

- 職員数
- 登録済みの勤務可否情報
- 生成済みシフトの有無

---

## マイグレーション手順

### Step 1: マイグレーションスクリプトの実行

```powershell
python scripts/migrate_to_v3.py
```

### Step 2: 確認プロンプトへの応答

```
シフト作成システム V3.0 マイグレーション
============================================================

⚠️  このマイグレーションは以下の変更を行います:
  - 勤務形態マスタテーブルを作成
  - 時間帯マスタを固定化
  - 休暇管理テーブルを作成
  - 既存の勤務可否データを休暇データに変換

V2.0からV3.0にマイグレーションしますか？ (yes/no):
```

**`yes`** と入力してEnter

### Step 3: マイグレーション実行

以下の処理が自動で実行されます：

1. **バックアップ作成**
   ```
   ✅ V2データをバックアップしました: data/shift_v2_backup_20251127_143022.db
   ```

2. **新テーブル作成**
   ```
   📦 Phase 1: 新テーブルを作成中...
   ```

3. **データ変換**
   ```
   🔄 Phase 2: 勤務形態データを移行中...
   🔄 Phase 3: 勤務可否データを休暇データに変換中...
     ✓ 45件の休暇データを変換しました
   ```

4. **時間帯固定化**
   ```
   🔄 Phase 4: 時間帯マスタを固定化中...
   ```

5. **完了**
   ```
   ✅ V3.0へのマイグレーションが完了しました
   
   ============================================================
   ✅ マイグレーションが正常に完了しました
   📁 バックアップ: data/shift_v2_backup_20251127_143022.db
   ============================================================
   ```

---

## マイグレーション後の確認

### 1. アプリケーション起動

```powershell
streamlit run main.py
```

### 2. 職員データの確認

1. **職員管理ページ**を開く
2. 各職員の**勤務パターン**が正しく設定されているか確認
   - P1 → `full_early`
   - P2 → `full_mid`
   - P3 → `full_late`
   - P4 → `short_time`
   - PT1 → `part_morning`
   - PT2 → `part_morning_ext`

### 3. 休暇データの確認

1. **休暇管理ページ**を開く
2. 各職員を選択し、休暇が正しく変換されているか確認
3. V2の勤務可否データは以下のルールで変換されます：
   - 午前・午後とも勤務不可 → **終日休暇**
   - 午前のみ勤務不可 → **午前休**
   - 午後のみ勤務不可 → **午後休**

### 4. シフト生成のテスト

1. **シフト生成ページ**を開く
2. サンプル期間でシフトを生成
3. 休暇が正しく反映されているか確認

---

## トラブルシューティング

### Q1. マイグレーションが途中で失敗した

**対処法**:

1. バックアップファイルを確認
   ```powershell
   Get-ChildItem data\shift_v2_backup_*.db | Sort-Object LastWriteTime -Descending | Select-Object -First 1
   ```

2. バックアップから復元
   ```powershell
   Copy-Item data\shift_v2_backup_YYYYMMDD_HHMMSS.db data\shift.db -Force
   ```

3. エラーメッセージを確認し、問題を解決後に再実行

### Q2. 休暇データが正しく変換されていない

**対処法**:

1. V2のavailabilityテーブルを確認
   ```powershell
   # SQLiteで直接確認
   sqlite3 data\shift_v2_backup_*.db "SELECT * FROM availability;"
   ```

2. 必要に応じて休暇管理ページで手動修正

### Q3. 勤務形態が正しく設定されていない

**対処法**:

1. 職員管理ページで各職員を編集
2. 正しい勤務パターンを選択し直す

### Q4. 時間帯が表示されない

**考えられる原因**:

- `time_slots`テーブルが正しく固定化されていない

**対処法**:

```python
# Pythonコンソールで実行
from database import init_fixed_time_slots
init_fixed_time_slots()
```

### Q5. ロールバックしたい

**手順**:

1. バックアップファイルを特定
   ```powershell
   Get-ChildItem data\shift_v2_backup_*.db
   ```

2. 復元
   ```powershell
   Copy-Item data\shift_v2_backup_YYYYMMDD_HHMMSS.db data\shift.db -Force
   ```

3. アプリケーション再起動
   ```powershell
   streamlit run main.py
   ```

---

## よくある質問

### Q. V2に戻すことはできますか？

A. はい、バックアップから復元することでV2に戻せます。ただし、V3で追加した休暇データは失われます。

### Q. マイグレーション後もV2の勤務可否データは残りますか？

A. はい、`availability`テーブルは削除されず残ります。ただし、V3では使用されません。

### Q. 時間帯を変更したい場合は？

A. V3.0では診療時間は固定です。どうしても変更が必要な場合は、データベースを直接編集する必要があります。

### Q. 新しい勤務形態を追加できますか？

A. `employment_patterns`テーブルにINSERTすることで追加可能です。将来のバージョンでUI対応を検討中です。

---

## サポート

問題が解決しない場合は、以下の情報を添えてお問い合わせください：

1. エラーメッセージ（スクリーンショット）
2. バックアップファイル名
3. マイグレーション実行時の日時
4. 環境情報（OS、Pythonバージョン）

---

**文書管理**
- 版数: 1.0
- 作成日: 2025-11-27
- 最終更新: 2025-11-27
