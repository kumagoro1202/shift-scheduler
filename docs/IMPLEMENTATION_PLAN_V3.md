# ã‚·ãƒ•ãƒˆä½œæˆã‚·ã‚¹ãƒ†ãƒ  V3.0 æ”¹ä¿®å®Ÿè£…è¨ˆç”»æ›¸

## ä½œæˆæ—¥: 2025å¹´11æœˆ27æ—¥

---

## ğŸ“‹ ç›®æ¬¡

1. [æ¦‚è¦](#1-æ¦‚è¦)
2. [å®Ÿè£…ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«](#2-å®Ÿè£…ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«)
3. [è©³ç´°å®Ÿè£…è¨ˆç”»](#3-è©³ç´°å®Ÿè£…è¨ˆç”»)
4. [ãƒ†ã‚¹ãƒˆè¨ˆç”»](#4-ãƒ†ã‚¹ãƒˆè¨ˆç”»)
5. [ãƒªã‚¹ã‚¯ç®¡ç†](#5-ãƒªã‚¹ã‚¯ç®¡ç†)

---

## 1. æ¦‚è¦

### 1.1 æ”¹ä¿®ã®ç›®çš„
- æ™‚é–“å¸¯ã”ã¨ã®å‹¤å‹™å¯å¦ç™»éŒ²ã‚’å»ƒæ­¢ã—ã€æ—¥ä»˜å˜ä½ã®ä¼‘æš‡ç™»éŒ²ã«ç°¡ç´ åŒ–
- è¨ºç™‚æ™‚é–“ã‚’å›ºå®šåŒ–ã—ã€ã‚·ã‚¹ãƒ†ãƒ ã®å …ç‰¢æ€§ã‚’å‘ä¸Š
- å‹¤å‹™å½¢æ…‹ãƒã‚¹ã‚¿ã‚’æ•´å‚™ã—ã€é‹ç”¨ã®æŸ”è»Ÿæ€§ã‚’ç¢ºä¿

### 1.2 ä¸»ãªå¤‰æ›´ç‚¹
1. **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒã®å¤‰æ›´**
   - `employee_absences` ãƒ†ãƒ¼ãƒ–ãƒ«ã®æ–°è¦ä½œæˆ
   - `employment_patterns` ãƒ†ãƒ¼ãƒ–ãƒ«ã®æ–°è¦ä½œæˆ
   - `time_slots` ãƒ†ãƒ¼ãƒ–ãƒ«ã®å›ºå®šåŒ–
   - `availability` ãƒ†ãƒ¼ãƒ–ãƒ«ã®å»ƒæ­¢

2. **UI/UX ã®å¤‰æ›´**
   - æ™‚é–“å¸¯è¨­å®šãƒšãƒ¼ã‚¸ã®å»ƒæ­¢
   - å‹¤å‹™å¯èƒ½æƒ…å ±ãƒšãƒ¼ã‚¸ â†’ ä¼‘æš‡ç®¡ç†ãƒšãƒ¼ã‚¸ã«æ”¹åãƒ»æ©Ÿèƒ½å¤‰æ›´
   - è·å“¡ç®¡ç†ãƒšãƒ¼ã‚¸ã®å‹¤å‹™å½¢æ…‹é¸æŠUIæ”¹ä¿®

3. **ãƒ­ã‚¸ãƒƒã‚¯ã®å¤‰æ›´**
   - å‹¤å‹™å¯å¦åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ã®å…¨é¢æ”¹ä¿®
   - ã‚·ãƒ•ãƒˆç”Ÿæˆã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã®èª¿æ•´

---

## 2. å®Ÿè£…ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«

### 2.1 ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ï¼ˆå…¨9æ—¥é–“ï¼‰

```
Day 1-2: Phase 1 - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åŸºç›¤
Day 3-4: Phase 2 - ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ©Ÿèƒ½
Day 5-6: Phase 3 - UIæ”¹ä¿®
Day 7-8: Phase 4 - ãƒ­ã‚¸ãƒƒã‚¯æ”¹ä¿®ã¨ãƒ†ã‚¹ãƒˆ
Day 9:   Phase 5 - ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã¨ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
```

### 2.2 å„Phaseã®è©³ç´°

| Phase | ã‚¿ã‚¹ã‚¯ | æˆæœç‰© | æ—¥æ•° |
|-------|--------|--------|------|
| Phase 1 | ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆãƒ»å®Ÿè£… | ã‚¹ã‚­ãƒ¼ãƒå®šç¾©ã€ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ | 2æ—¥ |
| Phase 2 | ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè£… | migration_v3.py | 2æ—¥ |
| Phase 3 | UIæ”¹ä¿® | ä¼‘æš‡ç®¡ç†ãƒšãƒ¼ã‚¸ã€è·å“¡ç®¡ç†æ”¹ä¿® | 2æ—¥ |
| Phase 4 | ãƒ­ã‚¸ãƒƒã‚¯æ”¹ä¿®ãƒ»ãƒ†ã‚¹ãƒˆ | optimizeræ”¹ä¿®ã€ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ | 2æ—¥ |
| Phase 5 | æœ€çµ‚èª¿æ•´ | ã‚µãƒ³ãƒ—ãƒ«DBã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ | 1æ—¥ |

---

## 3. è©³ç´°å®Ÿè£…è¨ˆç”»

### Phase 1: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åŸºç›¤æ•´å‚™ï¼ˆDay 1-2ï¼‰

#### Task 1.1: å‹¤å‹™å½¢æ…‹ãƒã‚¹ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ«ã®ä½œæˆ

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/database.py`

**å®Ÿè£…å†…å®¹**:
```python
def init_employment_patterns_table():
    """å‹¤å‹™å½¢æ…‹ãƒã‚¹ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆ"""
    conn = get_connection()
    cursor = conn.cursor()
    
    cursor.execute("""
        CREATE TABLE IF NOT EXISTS employment_patterns (
            id TEXT PRIMARY KEY,
            name TEXT NOT NULL,
            category TEXT NOT NULL,
            start_time TEXT NOT NULL,
            end_time TEXT NOT NULL,
            break_hours REAL NOT NULL,
            work_hours REAL NOT NULL,
            can_work_afternoon BOOLEAN DEFAULT 1,
            description TEXT,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            CHECK(category IN ('full_time', 'short_time', 'part_time'))
        )
    """)
    
    # åˆæœŸãƒ‡ãƒ¼ã‚¿æŠ•å…¥
    patterns = [
        ('full_early', 'ãƒ•ãƒ«ã‚¿ã‚¤ãƒ ï¼ˆæ—©ç•ªï¼‰', 'full_time', '08:30', '18:30', 2.0, 8.0, 1, 'æ­£è·å“¡ãƒ»æ—©ç•ª'),
        ('full_mid', 'ãƒ•ãƒ«ã‚¿ã‚¤ãƒ ï¼ˆä¸­ç•ªï¼‰', 'full_time', '08:45', '18:45', 2.0, 8.0, 1, 'æ­£è·å“¡ãƒ»ä¸­ç•ª'),
        ('full_late', 'ãƒ•ãƒ«ã‚¿ã‚¤ãƒ ï¼ˆé…ç•ªï¼‰', 'full_time', '09:00', '19:00', 2.0, 8.0, 1, 'æ­£è·å“¡ãƒ»é…ç•ª'),
        ('short_time', 'æ™‚çŸ­å‹¤å‹™', 'short_time', '08:45', '16:45', 1.0, 7.0, 0, 'æ­£è·å“¡ãƒ»æ™‚çŸ­'),
        ('part_morning', 'ãƒ‘ãƒ¼ãƒˆåˆå‰', 'part_time', '08:45', '12:45', 0.0, 4.0, 0, 'ãƒ‘ãƒ¼ãƒˆãƒ»åˆå‰4æ™‚é–“'),
        ('part_morning_ext', 'ãƒ‘ãƒ¼ãƒˆåˆå‰å»¶é•·', 'part_time', '08:45', '13:45', 0.0, 5.0, 0, 'ãƒ‘ãƒ¼ãƒˆãƒ»åˆå‰5æ™‚é–“'),
    ]
    
    cursor.executemany("""
        INSERT OR IGNORE INTO employment_patterns 
        (id, name, category, start_time, end_time, break_hours, work_hours, can_work_afternoon, description)
        VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)
    """, patterns)
    
    conn.commit()
    conn.close()
```

**é–¢é€£é–¢æ•°**:
```python
def get_all_employment_patterns() -> List[Dict[str, Any]]:
    """å…¨å‹¤å‹™å½¢æ…‹ã‚’å–å¾—"""
    
def get_employment_pattern_by_id(pattern_id: str) -> Optional[Dict[str, Any]]:
    """IDã§å‹¤å‹™å½¢æ…‹ã‚’å–å¾—"""
    
def get_employment_patterns_by_category(category: str) -> List[Dict[str, Any]]:
    """ã‚«ãƒ†ã‚´ãƒªã§å‹¤å‹™å½¢æ…‹ã‚’å–å¾—"""
```

**äºˆå®šå·¥æ•°**: 4æ™‚é–“

---

#### Task 1.2: æ™‚é–“å¸¯ãƒã‚¹ã‚¿ã®å›ºå®šåŒ–

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/database.py`

**å®Ÿè£…å†…å®¹**:
```python
def init_fixed_time_slots():
    """å›ºå®šæ™‚é–“å¸¯ãƒã‚¹ã‚¿ã‚’ä½œæˆ"""
    conn = get_connection()
    cursor = conn.cursor()
    
    # æ—¢å­˜ã®time_slotsãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
    cursor.execute("""
        CREATE TABLE IF NOT EXISTS time_slots_backup AS 
        SELECT * FROM time_slots
    """)
    
    # time_slotsãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å†ä½œæˆ
    cursor.execute("DROP TABLE IF EXISTS time_slots")
    
    cursor.execute("""
        CREATE TABLE time_slots (
            id TEXT PRIMARY KEY,
            day_of_week INTEGER NOT NULL,
            period TEXT NOT NULL,
            start_time TEXT NOT NULL,
            end_time TEXT NOT NULL,
            is_active BOOLEAN DEFAULT 1,
            required_staff INTEGER DEFAULT 2,
            area TEXT DEFAULT 'å—ä»˜',
            display_name TEXT NOT NULL,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            CHECK(day_of_week >= 0 AND day_of_week <= 6),
            CHECK(period IN ('morning', 'afternoon'))
        )
    """)
    
    # å›ºå®šæ™‚é–“å¸¯ãƒ‡ãƒ¼ã‚¿
    time_slots = [
        # æœˆæ›œ
        ('mon_am', 0, 'morning', '09:00', '12:30', 1, 2, 'å—ä»˜', 'æœˆæ›œåˆå‰'),
        ('mon_pm', 0, 'afternoon', '15:30', '18:30', 1, 2, 'å—ä»˜', 'æœˆæ›œåˆå¾Œ'),
        # ç«æ›œ
        ('tue_am', 1, 'morning', '09:00', '12:30', 1, 2, 'å—ä»˜', 'ç«æ›œåˆå‰'),
        ('tue_pm', 1, 'afternoon', '15:30', '18:30', 1, 2, 'å—ä»˜', 'ç«æ›œåˆå¾Œ'),
        # æ°´æ›œ
        ('wed_am', 2, 'morning', '09:00', '12:30', 1, 2, 'å—ä»˜', 'æ°´æ›œåˆå‰'),
        ('wed_pm', 2, 'afternoon', '15:30', '17:30', 1, 2, 'å—ä»˜', 'æ°´æ›œåˆå¾Œ'),
        # æœ¨æ›œ
        ('thu_am', 3, 'morning', '09:00', '12:30', 1, 2, 'å—ä»˜', 'æœ¨æ›œåˆå‰'),
        # é‡‘æ›œ
        ('fri_am', 4, 'morning', '09:00', '12:30', 1, 2, 'å—ä»˜', 'é‡‘æ›œåˆå‰'),
        ('fri_pm', 4, 'afternoon', '15:30', '18:30', 1, 2, 'å—ä»˜', 'é‡‘æ›œåˆå¾Œ'),
        # åœŸæ›œ
        ('sat_am', 5, 'morning', '09:00', '13:30', 1, 2, 'å—ä»˜', 'åœŸæ›œåˆå‰'),
    ]
    
    cursor.executemany("""
        INSERT INTO time_slots 
        (id, day_of_week, period, start_time, end_time, is_active, required_staff, area, display_name)
        VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)
    """, time_slots)
    
    conn.commit()
    conn.close()
```

**äºˆå®šå·¥æ•°**: 3æ™‚é–“

---

#### Task 1.3: ä¼‘æš‡ãƒ†ãƒ¼ãƒ–ãƒ«ã®ä½œæˆ

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/database.py`

**å®Ÿè£…å†…å®¹**:
```python
def init_employee_absences_table():
    """ä¼‘æš‡ç™»éŒ²ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆ"""
    conn = get_connection()
    cursor = conn.cursor()
    
    cursor.execute("""
        CREATE TABLE IF NOT EXISTS employee_absences (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            employee_id INTEGER NOT NULL,
            absence_date DATE NOT NULL,
            absence_type TEXT NOT NULL,
            reason TEXT,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (employee_id) REFERENCES employees(id) ON DELETE CASCADE,
            UNIQUE(employee_id, absence_date, absence_type),
            CHECK(absence_type IN ('full_day', 'morning', 'afternoon'))
        )
    """)
    
    # ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½œæˆ
    cursor.execute("""
        CREATE INDEX IF NOT EXISTS idx_absence_employee_date 
        ON employee_absences(employee_id, absence_date)
    """)
    
    conn.commit()
    conn.close()
```

**ä¼‘æš‡ç®¡ç†é–¢æ•°**:
```python
def add_absence(employee_id: int, absence_date: str, absence_type: str, reason: str = None) -> int:
    """ä¼‘æš‡ã‚’ç™»éŒ²"""
    
def remove_absence(employee_id: int, absence_date: str, absence_type: str = None) -> bool:
    """ä¼‘æš‡ã‚’å‰Šé™¤ï¼ˆabsence_typeæœªæŒ‡å®šã®å ´åˆã¯å…¨ç¨®åˆ¥å‰Šé™¤ï¼‰"""
    
def get_absence(employee_id: int, absence_date: str) -> Optional[Dict[str, Any]]:
    """æŒ‡å®šæ—¥ã®ä¼‘æš‡æƒ…å ±ã‚’å–å¾—"""
    
def get_absences_by_employee(employee_id: int, start_date: str, end_date: str) -> List[Dict[str, Any]]:
    """è·å“¡ã®æœŸé–“å†…ã®ä¼‘æš‡ä¸€è¦§ã‚’å–å¾—"""
    
def get_absences_by_date(absence_date: str) -> List[Dict[str, Any]]:
    """æŒ‡å®šæ—¥ã®å…¨è·å“¡ã®ä¼‘æš‡ä¸€è¦§ã‚’å–å¾—"""
```

**äºˆå®šå·¥æ•°**: 4æ™‚é–“

---

#### Task 1.4: employeesãƒ†ãƒ¼ãƒ–ãƒ«ã®æ‹¡å¼µ

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/database.py`

**å®Ÿè£…å†…å®¹**:
```python
def add_employment_pattern_to_employees():
    """employeesãƒ†ãƒ¼ãƒ–ãƒ«ã«employment_pattern_idã‚’è¿½åŠ """
    conn = get_connection()
    cursor = conn.cursor()
    
    try:
        cursor.execute("""
            ALTER TABLE employees 
            ADD COLUMN employment_pattern_id TEXT 
            REFERENCES employment_patterns(id)
        """)
        conn.commit()
    except sqlite3.OperationalError as e:
        # ã‚«ãƒ©ãƒ ãŒæ—¢ã«å­˜åœ¨ã™ã‚‹å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
        if "duplicate column name" not in str(e).lower():
            raise
    finally:
        conn.close()
```

**äºˆå®šå·¥æ•°**: 1æ™‚é–“

---

### Phase 2: ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ©Ÿèƒ½å®Ÿè£…ï¼ˆDay 3-4ï¼‰

#### Task 2.1: V2â†’V3ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

**æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«**: `src/migration_v3.py`

**å®Ÿè£…å†…å®¹**:
```python
"""
V2.0 â†’ V3.0 ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
"""
import sqlite3
from pathlib import Path
from datetime import datetime
from database import get_connection

def check_v3_migration_needed() -> bool:
    """V3ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒå¿…è¦ã‹ãƒã‚§ãƒƒã‚¯"""
    conn = get_connection()
    cursor = conn.cursor()
    
    try:
        # employment_patternsãƒ†ãƒ¼ãƒ–ãƒ«ã®å­˜åœ¨ç¢ºèª
        cursor.execute("""
            SELECT name FROM sqlite_master 
            WHERE type='table' AND name='employment_patterns'
        """)
        return cursor.fetchone() is None
    finally:
        conn.close()


def migrate_to_v3():
    """V2.0ã‹ã‚‰V3.0ã¸ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³"""
    print("ğŸ”„ V3.0ã¸ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é–‹å§‹ã—ã¾ã™...")
    
    conn = get_connection()
    cursor = conn.cursor()
    
    try:
        # Phase 1: æ–°ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
        print("ğŸ“¦ Phase 1: æ–°ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆä¸­...")
        from database import (
            init_employment_patterns_table,
            init_employee_absences_table,
            init_fixed_time_slots
        )
        
        init_employment_patterns_table()
        init_employee_absences_table()
        add_employment_pattern_to_employees()
        
        # Phase 2: work_pattern â†’ employment_pattern_id ãƒãƒƒãƒ”ãƒ³ã‚°
        print("ğŸ”„ Phase 2: å‹¤å‹™å½¢æ…‹ãƒ‡ãƒ¼ã‚¿ã‚’ç§»è¡Œä¸­...")
        pattern_mapping = {
            'P1': 'full_early',
            'P2': 'full_mid',
            'P3': 'full_late',
            'P4': 'short_time',
            'PT1': 'part_morning',
            'PT2': 'part_morning_ext',
        }
        
        for old_pattern, new_pattern in pattern_mapping.items():
            cursor.execute("""
                UPDATE employees 
                SET employment_pattern_id = ? 
                WHERE work_pattern = ?
            """, (new_pattern, old_pattern))
        
        # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤è¨­å®šï¼ˆwork_patternãŒæœªè¨­å®šã®å ´åˆï¼‰
        cursor.execute("""
            UPDATE employees 
            SET employment_pattern_id = 'full_early' 
            WHERE employment_pattern_id IS NULL
        """)
        
        # Phase 3: availability â†’ employee_absences å¤‰æ›
        print("ğŸ”„ Phase 3: å‹¤å‹™å¯å¦ãƒ‡ãƒ¼ã‚¿ã‚’ä¼‘æš‡ãƒ‡ãƒ¼ã‚¿ã«å¤‰æ›ä¸­...")
        
        # availabilityãƒ†ãƒ¼ãƒ–ãƒ«ãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿å‡¦ç†
        cursor.execute("""
            SELECT name FROM sqlite_master 
            WHERE type='table' AND name='availability'
        """)
        
        if cursor.fetchone():
            migrate_availability_to_absences(cursor)
        
        # Phase 4: æ™‚é–“å¸¯ãƒã‚¹ã‚¿ã®å›ºå®šåŒ–
        print("ğŸ”„ Phase 4: æ™‚é–“å¸¯ãƒã‚¹ã‚¿ã‚’å›ºå®šåŒ–ä¸­...")
        init_fixed_time_slots()
        
        # Phase 5: è¨­å®šãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®æ›´æ–°
        cursor.execute("""
            INSERT OR REPLACE INTO settings (key, value) 
            VALUES ('schema_version', '3.0')
        """)
        
        cursor.execute("""
            INSERT OR REPLACE INTO settings (key, value) 
            VALUES ('migration_date_v3', ?)
        """, (datetime.now().isoformat(),))
        
        conn.commit()
        print("âœ… V3.0ã¸ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒå®Œäº†ã—ã¾ã—ãŸ")
        return True
        
    except Exception as e:
        conn.rollback()
        print(f"âŒ ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")
        raise
    finally:
        conn.close()


def migrate_availability_to_absences(cursor):
    """availability â†’ employee_absences ãƒ‡ãƒ¼ã‚¿å¤‰æ›"""
    
    # æ—¥ä»˜ã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã—ã¦å‡¦ç†
    cursor.execute("""
        SELECT employee_id, date, 
               GROUP_CONCAT(time_slot_id) as slots,
               GROUP_CONCAT(is_available) as availabilities
        FROM availability
        GROUP BY employee_id, date
    """)
    
    for row in cursor.fetchall():
        employee_id = row[0]
        date = row[1]
        slots = row[2].split(',') if row[2] else []
        availabilities = [int(x) for x in row[3].split(',')] if row[3] else []
        
        # is_available=0ã®ã‚¹ãƒ­ãƒƒãƒˆã‚’ç‰¹å®š
        unavailable_slots = [
            slot for slot, avail in zip(slots, availabilities) 
            if avail == 0
        ]
        
        if not unavailable_slots:
            continue
        
        # ã‚¹ãƒ­ãƒƒãƒˆIDã‹ã‚‰åˆå‰/åˆå¾Œã‚’åˆ¤å®š
        morning_unavailable = any('am' in slot or 'åˆå‰' in slot for slot in unavailable_slots)
        afternoon_unavailable = any('pm' in slot or 'åˆå¾Œ' in slot for slot in unavailable_slots)
        
        # ä¼‘æš‡ç¨®åˆ¥ã®æ±ºå®š
        if morning_unavailable and afternoon_unavailable:
            absence_type = 'full_day'
        elif morning_unavailable:
            absence_type = 'morning'
        elif afternoon_unavailable:
            absence_type = 'afternoon'
        else:
            continue
        
        # ä¼‘æš‡ãƒ‡ãƒ¼ã‚¿æŒ¿å…¥
        cursor.execute("""
            INSERT OR IGNORE INTO employee_absences 
            (employee_id, absence_date, absence_type, reason)
            VALUES (?, ?, ?, ?)
        """, (employee_id, date, absence_type, 'V2ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ç§»è¡Œ'))
    
    print(f"  âœ“ {cursor.rowcount}ä»¶ã®ä¼‘æš‡ãƒ‡ãƒ¼ã‚¿ã‚’å¤‰æ›ã—ã¾ã—ãŸ")


def backup_v2_data():
    """V2ãƒ‡ãƒ¼ã‚¿ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—"""
    from database import DB_PATH
    import shutil
    
    backup_path = DB_PATH.parent / f"shift_v2_backup_{datetime.now():%Y%m%d_%H%M%S}.db"
    shutil.copy2(DB_PATH, backup_path)
    print(f"âœ… V2ãƒ‡ãƒ¼ã‚¿ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã—ã¾ã—ãŸ: {backup_path}")
    return backup_path
```

**äºˆå®šå·¥æ•°**: 8æ™‚é–“

---

#### Task 2.2: ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œã‚¹ã‚¯ãƒªãƒ—ãƒˆ

**æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«**: `scripts/migrate_to_v3.py`

```python
"""
V3.0ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œã‚¹ã‚¯ãƒªãƒ—ãƒˆ
"""
import sys
from pathlib import Path

sys.path.insert(0, str(Path(__file__).parent.parent / "src"))

from migration_v3 import (
    check_v3_migration_needed,
    migrate_to_v3,
    backup_v2_data
)

def main():
    print("=" * 60)
    print("ã‚·ãƒ•ãƒˆä½œæˆã‚·ã‚¹ãƒ†ãƒ  V3.0 ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³")
    print("=" * 60)
    print()
    
    # ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å¿…è¦æ€§ãƒã‚§ãƒƒã‚¯
    if not check_v3_migration_needed():
        print("âœ… æ—¢ã«V3.0ã«ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ¸ˆã¿ã§ã™")
        return
    
    # ç¢ºèªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
    response = input("V2.0ã‹ã‚‰V3.0ã«ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã—ã¾ã™ã‹ï¼Ÿ (yes/no): ")
    if response.lower() not in ['yes', 'y']:
        print("âŒ ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ")
        return
    
    # ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
    print()
    backup_path = backup_v2_data()
    print()
    
    # ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
    try:
        migrate_to_v3()
        print()
        print("=" * 60)
        print("âœ… ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸ")
        print(f"ğŸ“ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—: {backup_path}")
        print("=" * 60)
    except Exception as e:
        print()
        print("=" * 60)
        print(f"âŒ ã‚¨ãƒ©ãƒ¼: {e}")
        print(f"ğŸ“ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰å¾©å…ƒã—ã¦ãã ã•ã„: {backup_path}")
        print("=" * 60)
        sys.exit(1)

if __name__ == "__main__":
    main()
```

**äºˆå®šå·¥æ•°**: 2æ™‚é–“

---

### Phase 3: UIæ”¹ä¿®ï¼ˆDay 5-6ï¼‰

#### Task 3.1: ä¼‘æš‡ç®¡ç†ãƒšãƒ¼ã‚¸ã®ä½œæˆ

**ãƒ•ã‚¡ã‚¤ãƒ«åå¤‰æ›´**: 
- `pages/3_ğŸ“…_å‹¤å‹™å¯èƒ½æƒ…å ±.py` â†’ `pages/3_ğŸ–ï¸_ä¼‘æš‡ç®¡ç†.py`

**å®Ÿè£…å†…å®¹**:
```python
"""
ä¼‘æš‡ç®¡ç†ãƒšãƒ¼ã‚¸ï¼ˆV3.0ï¼‰
"""
import streamlit as st
import sys
from pathlib import Path
from datetime import datetime, timedelta
import calendar

sys.path.append(str(Path(__file__).parent.parent / "src"))

from database import (
    get_all_employees,
    add_absence,
    remove_absence,
    get_absence,
    get_absences_by_employee
)

st.set_page_config(page_title="ä¼‘æš‡ç®¡ç†", page_icon="ğŸ–ï¸", layout="wide")

st.title("ğŸ–ï¸ ä¼‘æš‡ç®¡ç†")

st.info("ğŸ’¡ **ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‹•ä½œ**: ä¼‘æš‡ç™»éŒ²ã®ãªã„æ—¥ã¯è‡ªå‹•çš„ã«ã€Œå‹¤å‹™å¯èƒ½ã€ã§ã™ã€‚ä¼‘æš‡ã‚’å–ã‚‹æ—¥ã®ã¿ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚")

# è·å“¡é¸æŠ
employees = get_all_employees()
if not employees:
    st.warning("âš ï¸ è·å“¡ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“")
    st.stop()

selected_employee = st.selectbox(
    "è·å“¡ã‚’é¸æŠ",
    options=employees,
    format_func=lambda x: f"{x['name']} ({x.get('employment_pattern_id', 'ãƒ•ãƒ«ã‚¿ã‚¤ãƒ ')})"
)

# å¹´æœˆé¸æŠ
col1, col2 = st.columns(2)
with col1:
    year = st.selectbox("å¹´", range(datetime.now().year, datetime.now().year + 2))
with col2:
    month = st.selectbox("æœˆ", range(1, 13), index=datetime.now().month - 1)

# ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¡¨ç¤º
st.subheader(f"{year}å¹´{month}æœˆ ä¼‘æš‡ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼")

# æœˆã®æ—¥ä»˜ãƒªã‚¹ãƒˆç”Ÿæˆ
cal = calendar.monthcalendar(year, month)
weekday_names = ['æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ', 'æ—¥']

# ãƒ˜ãƒƒãƒ€ãƒ¼
header_cols = st.columns(7)
for idx, day_name in enumerate(weekday_names):
    with header_cols[idx]:
        st.markdown(f"**{day_name}**")

# ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æœ¬ä½“
for week in cal:
    cols = st.columns(7)
    for idx, day in enumerate(week):
        with cols[idx]:
            if day == 0:
                st.markdown("&nbsp;")
                continue
            
            date_obj = datetime(year, month, day)
            date_str = date_obj.strftime("%Y-%m-%d")
            is_sunday = idx == 6
            
            # ä¼‘æš‡æƒ…å ±å–å¾—
            absence = get_absence(selected_employee['id'], date_str)
            
            # è¡¨ç¤ºã‚¢ã‚¤ã‚³ãƒ³
            if is_sunday:
                icon = "ğŸŒ™"
                status = "å®šä¼‘"
            elif absence:
                if absence['absence_type'] == 'full_day':
                    icon = "ğŸ–ï¸"
                    status = "çµ‚æ—¥ä¼‘æš‡"
                elif absence['absence_type'] == 'morning':
                    icon = "ğŸŒ…"
                    status = "åˆå‰ä¼‘"
                else:
                    icon = "ğŸŒ†"
                    status = "åˆå¾Œä¼‘"
            else:
                icon = "âœ…"
                status = "å‹¤å‹™å¯èƒ½"
            
            st.markdown(f"**{day}**")
            st.markdown(f"{icon} {status}")
            
            # è¨­å®šãƒœã‚¿ãƒ³
            if not is_sunday:
                with st.expander("è¨­å®š"):
                    current_type = absence['absence_type'] if absence else None
                    
                    absence_type = st.radio(
                        "çŠ¶æ…‹",
                        ["å‹¤å‹™å¯èƒ½", "çµ‚æ—¥ä¼‘æš‡", "åˆå‰ä¼‘", "åˆå¾Œä¼‘"],
                        index=["å‹¤å‹™å¯èƒ½", "çµ‚æ—¥ä¼‘æš‡", "åˆå‰ä¼‘", "åˆå¾Œä¼‘"].index(
                            status if status in ["å‹¤å‹™å¯èƒ½", "çµ‚æ—¥ä¼‘æš‡", "åˆå‰ä¼‘", "åˆå¾Œä¼‘"] else "å‹¤å‹™å¯èƒ½"
                        ),
                        key=f"absence_{date_str}"
                    )
                    
                    reason = st.text_input("ç†ç”±", value=absence.get('reason', '') if absence else '', key=f"reason_{date_str}")
                    
                    if st.button("ä¿å­˜", key=f"save_{date_str}"):
                        if absence_type == "å‹¤å‹™å¯èƒ½":
                            remove_absence(selected_employee['id'], date_str)
                            st.success("âœ… å‹¤å‹™å¯èƒ½ã«è¨­å®šã—ã¾ã—ãŸ")
                        else:
                            type_map = {
                                "çµ‚æ—¥ä¼‘æš‡": "full_day",
                                "åˆå‰ä¼‘": "morning",
                                "åˆå¾Œä¼‘": "afternoon"
                            }
                            add_absence(
                                selected_employee['id'],
                                date_str,
                                type_map[absence_type],
                                reason
                            )
                            st.success(f"âœ… {absence_type}ã‚’ç™»éŒ²ã—ã¾ã—ãŸ")
                        st.rerun()
```

**äºˆå®šå·¥æ•°**: 6æ™‚é–“

---

#### Task 3.2: æ™‚é–“å¸¯è¨­å®šãƒšãƒ¼ã‚¸ã®å»ƒæ­¢

**å¯¾å¿œå†…å®¹**:
1. `pages/2_â°_æ™‚é–“å¸¯è¨­å®š.py` ã‚’å‰Šé™¤
2. `main.py` ã«è¨ºç™‚ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¡¨ç¤ºã‚’è¿½åŠ 

**main.pyã¸ã®è¿½åŠ **:
```python
# ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¨ºç™‚ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¡¨ç¤º
st.subheader("ğŸ“… è¨ºç™‚ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«")

with st.expander("è¨ºç™‚æ™‚é–“ã‚’ç¢ºèª", expanded=False):
    schedule_data = {
        "æ›œæ—¥": ["æœˆ", "ç«", "æ°´", "æœ¨", "é‡‘", "åœŸ", "æ—¥"],
        "åˆå‰": ["09:00-12:30", "09:00-12:30", "09:00-12:30", "09:00-12:30", "09:00-12:30", "09:00-13:30", "ä¼‘è¨º"],
        "åˆå¾Œ": ["15:30-18:30", "15:30-18:30", "15:30-17:30", "ä¼‘è¨º", "15:30-18:30", "ä¼‘è¨º", "ä¼‘è¨º"]
    }
    
    import pandas as pd
    st.dataframe(pd.DataFrame(schedule_data), use_container_width=True)
```

**äºˆå®šå·¥æ•°**: 2æ™‚é–“

---

#### Task 3.3: è·å“¡ç®¡ç†ãƒšãƒ¼ã‚¸ã®æ”¹ä¿®

**ãƒ•ã‚¡ã‚¤ãƒ«**: `pages/1_ğŸ‘¥_è·å“¡ç®¡ç†.py`

**å¤‰æ›´å†…å®¹**:
- `work_pattern` é¸æŠã‚’ `employment_pattern_id` é¸æŠã«å¤‰æ›´
- å‹¤å‹™å½¢æ…‹ãƒã‚¹ã‚¿ã‹ã‚‰é¸æŠè‚¢ã‚’å–å¾—

```python
# å‹¤å‹™å½¢æ…‹é¸æŠï¼ˆå¤‰æ›´å¾Œï¼‰
from database import get_all_employment_patterns

patterns = get_all_employment_patterns()

# é›‡ç”¨å½¢æ…‹ã«å¿œã˜ã¦ãƒ•ã‚£ãƒ«ã‚¿
if employment_type == "æ­£è·å“¡":
    available_patterns = [p for p in patterns if p['category'] in ['full_time', 'short_time']]
else:
    available_patterns = [p for p in patterns if p['category'] == 'part_time']

employment_pattern_id = st.selectbox(
    "å‹¤å‹™å½¢æ…‹",
    options=[p['id'] for p in available_patterns],
    format_func=lambda x: next(
        f"{p['name']} ({p['start_time']}-{p['end_time']})" 
        for p in available_patterns if p['id'] == x
    )
)
```

**äºˆå®šå·¥æ•°**: 4æ™‚é–“

---

### Phase 4: ãƒ­ã‚¸ãƒƒã‚¯æ”¹ä¿®ã¨ãƒ†ã‚¹ãƒˆï¼ˆDay 7-8ï¼‰

#### Task 4.1: å‹¤å‹™å¯å¦åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ã®æ”¹ä¿®

**æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«**: `src/availability_checker.py`

```python
"""
å‹¤å‹™å¯å¦åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ï¼ˆV3.0ï¼‰
"""
from datetime import datetime
from typing import Optional
from database import (
    get_employment_pattern_by_id,
    get_absence
)

def is_employee_available(employee, date_str: str, time_slot) -> bool:
    """
    è·å“¡ãŒæŒ‡å®šæ—¥ã®æŒ‡å®šæ™‚é–“å¸¯ã«å‹¤å‹™å¯èƒ½ã‹ã‚’åˆ¤å®š
    
    Args:
        employee: è·å“¡æƒ…å ±ï¼ˆdictï¼‰
        date_str: æ—¥ä»˜æ–‡å­—åˆ— (YYYY-MM-DD)
        time_slot: æ™‚é–“å¸¯æƒ…å ±ï¼ˆdictï¼‰
    
    Returns:
        bool: å‹¤å‹™å¯èƒ½ãªã‚‰True
    """
    # 1. æ™‚é–“å¸¯ãŒä¼‘è¨ºã®å ´åˆ
    if not time_slot.get('is_active', True):
        return False
    
    # 2. æ—¥æ›œæ—¥ãƒã‚§ãƒƒã‚¯
    date_obj = datetime.strptime(date_str, "%Y-%m-%d")
    if date_obj.weekday() == 6:  # æ—¥æ›œæ—¥
        return False
    
    # 3. ä¼‘æš‡ãƒã‚§ãƒƒã‚¯
    absence = get_absence(employee['id'], date_str)
    if absence:
        if absence['absence_type'] == 'full_day':
            return False
        if absence['absence_type'] == 'morning' and time_slot['period'] == 'morning':
            return False
        if absence['absence_type'] == 'afternoon' and time_slot['period'] == 'afternoon':
            return False
    
    # 4. å‹¤å‹™å½¢æ…‹ãƒã‚§ãƒƒã‚¯
    pattern = get_employment_pattern_by_id(employee.get('employment_pattern_id', 'full_early'))
    if not pattern:
        return False
    
    # åˆå¾Œå‹¤å‹™å¯å¦ãƒã‚§ãƒƒã‚¯
    if time_slot['period'] == 'afternoon' and not pattern.get('can_work_afternoon', True):
        return False
    
    # å‹¤å‹™æ™‚é–“ç¯„å›²ãƒã‚§ãƒƒã‚¯
    slot_start = datetime.strptime(time_slot['start_time'], "%H:%M").time()
    slot_end = datetime.strptime(time_slot['end_time'], "%H:%M").time()
    pattern_start = datetime.strptime(pattern['start_time'], "%H:%M").time()
    pattern_end = datetime.strptime(pattern['end_time'], "%H:%M").time()
    
    if slot_start < pattern_start or slot_end > pattern_end:
        return False
    
    return True


def get_available_time_slots_for_date(employee, date_str: str, all_time_slots):
    """æŒ‡å®šæ—¥ã«å‹¤å‹™å¯èƒ½ãªæ™‚é–“å¸¯ã®ãƒªã‚¹ãƒˆã‚’å–å¾—"""
    return [
        ts for ts in all_time_slots
        if is_employee_available(employee, date_str, ts)
    ]
```

**äºˆå®šå·¥æ•°**: 4æ™‚é–“

---

#### Task 4.2: ã‚·ãƒ•ãƒˆç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ã®æ”¹ä¿®

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/optimizer_v2.py`

**å¤‰æ›´ç®‡æ‰€**:
```python
# æ—§: availabilityãƒ†ãƒ¼ãƒ–ãƒ«å‚ç…§
# is_available = is_employee_available(emp_id, date_str, ts_id)

# æ–°: availability_checkerä½¿ç”¨
from availability_checker import is_employee_available

# è·å“¡æƒ…å ±ã¨æ™‚é–“å¸¯æƒ…å ±ã‚’æ¸¡ã™
employee = get_employee_by_id(emp_id)
time_slot = get_time_slot_by_id(ts_id)
is_available = is_employee_available(employee, date_str, time_slot)
```

**äºˆå®šå·¥æ•°**: 4æ™‚é–“

---

#### Task 4.3: ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã®ä½œæˆ

**æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«**: `tests/test_availability_v3.py`

```python
"""
V3.0 å‹¤å‹™å¯å¦åˆ¤å®šã®ãƒ†ã‚¹ãƒˆ
"""
import sys
from pathlib import Path
from datetime import datetime

sys.path.insert(0, str(Path(__file__).parent.parent / "src"))

from availability_checker import is_employee_available
from database import (
    init_database,
    create_employee,
    add_absence,
    get_all_time_slots
)

def test_full_day_absence():
    """çµ‚æ—¥ä¼‘æš‡ã®ãƒ†ã‚¹ãƒˆ"""
    init_database()
    
    emp_id = create_employee(
        name="ãƒ†ã‚¹ãƒˆè·å“¡",
        employment_pattern_id="full_early"
    )
    
    employee = {'id': emp_id, 'employment_pattern_id': 'full_early'}
    
    # çµ‚æ—¥ä¼‘æš‡ç™»éŒ²
    add_absence(emp_id, "2025-12-01", "full_day")
    
    time_slots = get_all_time_slots()
    
    # å…¨æ™‚é–“å¸¯ã§å‹¤å‹™ä¸å¯ã®ã¯ãš
    for ts in time_slots:
        if ts['id'] == 'mon_am' or ts['id'] == 'mon_pm':
            assert not is_employee_available(employee, "2025-12-01", ts)
    
    print("âœ… çµ‚æ—¥ä¼‘æš‡ãƒ†ã‚¹ãƒˆ: PASS")

def test_morning_absence():
    """åˆå‰ä¼‘ã®ãƒ†ã‚¹ãƒˆ"""
    # å®Ÿè£…çœç•¥
    pass

def test_afternoon_absence():
    """åˆå¾Œä¼‘ã®ãƒ†ã‚¹ãƒˆ"""
    # å®Ÿè£…çœç•¥
    pass

def test_part_time_afternoon():
    """ãƒ‘ãƒ¼ãƒˆè·å“¡ã®åˆå¾Œå‹¤å‹™ä¸å¯ãƒ†ã‚¹ãƒˆ"""
    # å®Ÿè£…çœç•¥
    pass

if __name__ == "__main__":
    test_full_day_absence()
    test_morning_absence()
    test_afternoon_absence()
    test_part_time_afternoon()
    print("âœ… å…¨ãƒ†ã‚¹ãƒˆå®Œäº†")
```

**äºˆå®šå·¥æ•°**: 4æ™‚é–“

---

### Phase 5: ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã¨ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆï¼ˆDay 9ï¼‰

#### Task 5.1: ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿æŠ•å…¥ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

**æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«**: `scripts/init_v3_sample_data.py`

```python
"""
V3.0ç”¨ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿æŠ•å…¥
"""
import sys
from pathlib import Path
from datetime import datetime, timedelta

sys.path.insert(0, str(Path(__file__).parent.parent / "src"))

from database import (
    init_database,
    create_employee,
    add_absence
)
from migration_v3 import migrate_to_v3, check_v3_migration_needed

def init_sample_data():
    """ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’æŠ•å…¥"""
    
    print("=" * 60)
    print("ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿æŠ•å…¥")
    print("=" * 60)
    
    # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆæœŸåŒ–
    init_database()
    
    # V3ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
    if check_v3_migration_needed():
        migrate_to_v3()
    
    print("\nè·å“¡ãƒ‡ãƒ¼ã‚¿æŠ•å…¥ä¸­...")
    
    # è·å“¡ãƒ‡ãƒ¼ã‚¿
    employees_data = [
        {
            'name': 'å±±ç”°å¤ªéƒ',
            'employee_type': 'TYPE_A',
            'employment_type': 'æ­£è·å“¡',
            'employment_pattern_id': 'full_early',
            'skill_reha_room': 85,
            'skill_reception_am': 90,
            'skill_reception_pm': 85,
            'skill_flexibility': 90
        },
        {
            'name': 'ä½è—¤èŠ±å­',
            'employee_type': 'TYPE_A',
            'employment_type': 'æ­£è·å“¡',
            'employment_pattern_id': 'full_mid',
            'skill_reha_room': 80,
            'skill_reception_am': 85,
            'skill_reception_pm': 90,
            'skill_flexibility': 85
        },
        {
            'name': 'éˆ´æœ¨ä¸€éƒ',
            'employee_type': 'TYPE_B',
            'employment_type': 'æ­£è·å“¡',
            'employment_pattern_id': 'full_late',
            'skill_reha_room': 0,
            'skill_reception_am': 95,
            'skill_reception_pm': 95,
            'skill_flexibility': 80
        },
        {
            'name': 'ç”°ä¸­ç¾å’²',
            'employee_type': 'TYPE_C',
            'employment_type': 'æ­£è·å“¡',
            'employment_pattern_id': 'short_time',
            'skill_reha_room': 90,
            'skill_reception_am': 0,
            'skill_reception_pm': 0,
            'skill_flexibility': 75
        },
        {
            'name': 'é«˜æ©‹å¥å¤ª',
            'employee_type': 'TYPE_D',
            'employment_type': 'ãƒ‘ãƒ¼ãƒˆ',
            'employment_pattern_id': 'part_morning',
            'skill_reha_room': 70,
            'skill_reception_am': 0,
            'skill_reception_pm': 0,
            'skill_flexibility': 60
        },
    ]
    
    employee_ids = []
    for emp_data in employees_data:
        emp_id = create_employee(**emp_data)
        employee_ids.append(emp_id)
        print(f"  âœ“ {emp_data['name']} ã‚’ç™»éŒ²ã—ã¾ã—ãŸ")
    
    print("\nä¼‘æš‡ãƒ‡ãƒ¼ã‚¿æŠ•å…¥ä¸­...")
    
    # ã‚µãƒ³ãƒ—ãƒ«ä¼‘æš‡ãƒ‡ãƒ¼ã‚¿
    base_date = datetime(2025, 12, 1)
    absences = [
        (employee_ids[0], base_date + timedelta(days=4), 'full_day', 'å¹´æ¬¡æœ‰çµ¦ä¼‘æš‡'),
        (employee_ids[1], base_date + timedelta(days=11), 'morning', 'é€šé™¢'),
        (employee_ids[2], base_date + timedelta(days=19), 'full_day', 'å¹´æ¬¡æœ‰çµ¦ä¼‘æš‡'),
        (employee_ids[3], base_date + timedelta(days=24), 'full_day', 'å¹´æ¬¡æœ‰çµ¦ä¼‘æš‡'),
    ]
    
    for emp_id, date_obj, absence_type, reason in absences:
        add_absence(emp_id, date_obj.strftime("%Y-%m-%d"), absence_type, reason)
        print(f"  âœ“ {employees_data[employee_ids.index(emp_id)]['name']} ã®ä¼‘æš‡ã‚’ç™»éŒ²ã—ã¾ã—ãŸ")
    
    print("\n" + "=" * 60)
    print("âœ… ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã®æŠ•å…¥ãŒå®Œäº†ã—ã¾ã—ãŸ")
    print("=" * 60)

if __name__ == "__main__":
    init_sample_data()
```

**äºˆå®šå·¥æ•°**: 3æ™‚é–“

---

#### Task 5.2: ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°

**æ›´æ–°å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«**:
1. `README.md` - V3.0ã®æ–°æ©Ÿèƒ½èª¬æ˜è¿½åŠ 
2. `docs/USER_GUIDE.md` - ä¼‘æš‡ç®¡ç†ã®ä½¿ã„æ–¹è¿½åŠ 
3. `docs/MIGRATION_GUIDE_V2_TO_V3.md` - æ–°è¦ä½œæˆ

**äºˆå®šå·¥æ•°**: 3æ™‚é–“

---

#### Task 5.3: ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ä½œæˆ

**æ‰‹é †**:
```powershell
# 1. æ—¢å­˜DBã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
Copy-Item data\shift.db data\shift_backup.db

# 2. DBã®åˆæœŸåŒ–
Remove-Item data\shift.db

# 3. ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿æŠ•å…¥
python scripts\init_v3_sample_data.py

# 4. å‹•ä½œç¢ºèª
streamlit run main.py
```

**äºˆå®šå·¥æ•°**: 2æ™‚é–“

---

## 4. ãƒ†ã‚¹ãƒˆè¨ˆç”»

### 4.1 å˜ä½“ãƒ†ã‚¹ãƒˆ

| ãƒ†ã‚¹ãƒˆé …ç›® | å¯¾è±¡é–¢æ•° | æœŸå¾…çµæœ |
|-----------|---------|---------|
| çµ‚æ—¥ä¼‘æš‡åˆ¤å®š | `is_employee_available` | å…¨æ™‚é–“å¸¯ã§å‹¤å‹™ä¸å¯ |
| åˆå‰ä¼‘åˆ¤å®š | `is_employee_available` | åˆå‰ã®ã¿å‹¤å‹™ä¸å¯ |
| åˆå¾Œä¼‘åˆ¤å®š | `is_employee_available` | åˆå¾Œã®ã¿å‹¤å‹™ä¸å¯ |
| ãƒ‘ãƒ¼ãƒˆåˆå¾Œå‹¤å‹™ | `is_employee_available` | åˆå¾Œã¯å¸¸ã«å‹¤å‹™ä¸å¯ |
| æ™‚çŸ­åˆå¾Œå‹¤å‹™ | `is_employee_available` | åˆå¾Œã¯å¸¸ã«å‹¤å‹™ä¸å¯ |
| å‹¤å‹™æ™‚é–“ç¯„å›²å¤– | `is_employee_available` | å‹¤å‹™ä¸å¯ |

### 4.2 çµåˆãƒ†ã‚¹ãƒˆ

| ãƒ†ã‚¹ãƒˆé …ç›® | ãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ª |
|-----------|--------------|
| ã‚·ãƒ•ãƒˆç”Ÿæˆï¼ˆä¼‘æš‡ã‚ã‚Šï¼‰ | ä¼‘æš‡ç™»éŒ²ã—ãŸè·å“¡ãŒè©²å½“æ—¥ã®ã‚·ãƒ•ãƒˆã«å«ã¾ã‚Œãªã„ |
| ã‚·ãƒ•ãƒˆç”Ÿæˆï¼ˆãƒ‘ãƒ¼ãƒˆï¼‰ | ãƒ‘ãƒ¼ãƒˆè·å“¡ãŒåˆå¾Œã‚·ãƒ•ãƒˆã«å«ã¾ã‚Œãªã„ |
| ä¼‘æš‡ç™»éŒ²ãƒ»å‰Šé™¤ | ä¼‘æš‡ç™»éŒ²å¾Œã€ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«åæ˜ ã•ã‚Œã‚‹ |
| ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ | V2ãƒ‡ãƒ¼ã‚¿ãŒæ­£å¸¸ã«V3ã«å¤‰æ›ã•ã‚Œã‚‹ |

### 4.3 E2Eãƒ†ã‚¹ãƒˆ

| ãƒ†ã‚¹ãƒˆé …ç›® | æ“ä½œæ‰‹é † | æœŸå¾…çµæœ |
|-----------|---------|---------|
| ä¼‘æš‡ç™»éŒ²ãƒ•ãƒ­ãƒ¼ | è·å“¡é¸æŠâ†’æ—¥ä»˜é¸æŠâ†’ä¼‘æš‡ç¨®åˆ¥é¸æŠâ†’ä¿å­˜ | ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«åæ˜  |
| ã‚·ãƒ•ãƒˆç”Ÿæˆãƒ•ãƒ­ãƒ¼ | ä¼‘æš‡ç™»éŒ²â†’ã‚·ãƒ•ãƒˆç”Ÿæˆâ†’çµæœç¢ºèª | ä¼‘æš‡æ—¥ã¯å‹¤å‹™ãªã— |
| Excelå‡ºåŠ› | ã‚·ãƒ•ãƒˆç”Ÿæˆâ†’Excelå‡ºåŠ› | æ­£å¸¸ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ |

---

## 5. ãƒªã‚¹ã‚¯ç®¡ç†

### 5.1 æŠ€è¡“çš„ãƒªã‚¹ã‚¯

| ãƒªã‚¹ã‚¯ | å½±éŸ¿åº¦ | å¯¾ç­– |
|-------|-------|------|
| ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å¤±æ•— | é«˜ | ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ©Ÿèƒ½ã®å®Ÿè£…ã€ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ‰‹é †ã®æ•´å‚™ |
| ãƒ‡ãƒ¼ã‚¿æå¤± | é«˜ | ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å‰ã®è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ— |
| ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åŠ£åŒ– | ä¸­ | ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½œæˆã€ã‚¯ã‚¨ãƒªæœ€é©åŒ– |
| UIä¸å…·åˆ | ä¸­ | ååˆ†ãªãƒ†ã‚¹ãƒˆæœŸé–“ã®ç¢ºä¿ |

### 5.2 ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒªã‚¹ã‚¯

| ãƒªã‚¹ã‚¯ | å½±éŸ¿åº¦ | å¯¾ç­– |
|-------|-------|------|
| å®Ÿè£…é…å»¶ | ä¸­ | å„ªå…ˆåº¦ã‚’æ˜ç¢ºåŒ–ã€Phaseå˜ä½ã§ã®ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³è¨­å®š |
| ãƒ†ã‚¹ãƒˆä¸è¶³ | é«˜ | Phase 4ã«ååˆ†ãªæ™‚é–“ã‚’ç¢ºä¿ |
| ä»•æ§˜å¤‰æ›´ | ä¸­ | è¦ä»¶å®šç¾©ã®æ—©æœŸç¢ºå®š |

### 5.3 é‹ç”¨ãƒªã‚¹ã‚¯

| ãƒªã‚¹ã‚¯ | å½±éŸ¿åº¦ | å¯¾ç­– |
|-------|-------|------|
| ãƒ¦ãƒ¼ã‚¶ãƒ¼æ··ä¹± | ä¸­ | è©³ç´°ãªãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¬ã‚¤ãƒ‰ä½œæˆ |
| ãƒ‡ãƒ¼ã‚¿ä¸æ•´åˆ | é«˜ | ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å¾Œã®æ¤œè¨¼ã‚¹ã‚¯ãƒªãƒ—ãƒˆ |
| ãƒã‚°ç™ºè¦‹ | ä¸­ | ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ‰‹é †ã®æ˜ç¤º |

---

## 6. ãƒªãƒªãƒ¼ã‚¹æ‰‹é †

### 6.1 ãƒªãƒªãƒ¼ã‚¹å‰ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

- [ ] å…¨å˜ä½“ãƒ†ã‚¹ãƒˆãŒåˆæ ¼
- [ ] å…¨çµåˆãƒ†ã‚¹ãƒˆãŒåˆæ ¼
- [ ] ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å‹•ä½œç¢ºèª
- [ ] ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã®å‹•ä½œç¢ºèª
- [ ] ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®æ›´æ–°å®Œäº†
- [ ] ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ»ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ‰‹é †ã®æ¤œè¨¼

### 6.2 ãƒªãƒªãƒ¼ã‚¹ä½œæ¥­

1. **ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆ**
   ```powershell
   python scripts/migrate_to_v3.py
   # â†’ è‡ªå‹•ã§ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãŒä½œæˆã•ã‚Œã‚‹
   ```

2. **ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ**
   - ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®æŒ‡ç¤ºã«å¾“ã†
   - ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã¯ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯

3. **å‹•ä½œç¢ºèª**
   ```powershell
   streamlit run main.py
   ```
   - å…¨ãƒšãƒ¼ã‚¸ãŒæ­£å¸¸ã«è¡¨ç¤ºã•ã‚Œã‚‹ã‹ç¢ºèª
   - ã‚µãƒ³ãƒ—ãƒ«ã‚·ãƒ•ãƒˆã‚’ç”Ÿæˆã—ã¦ç¢ºèª

4. **ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®å¼•ãæ¸¡ã—**
   - ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¬ã‚¤ãƒ‰ã®å…±æœ‰
   - æ–°æ©Ÿèƒ½ã®èª¬æ˜
   - ã‚µãƒãƒ¼ãƒˆä½“åˆ¶ã®æ¡ˆå†…

---

## 7. ä»˜éŒ²

### 7.1 ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆï¼ˆå¤‰æ›´å¾Œï¼‰

```
src/
  â”œâ”€â”€ database.py                  (æ›´æ–°)
  â”œâ”€â”€ migration_v3.py              (æ–°è¦)
  â”œâ”€â”€ availability_checker.py      (æ–°è¦)
  â”œâ”€â”€ optimizer_v2.py              (æ›´æ–°)
  â””â”€â”€ ...

pages/
  â”œâ”€â”€ 1_ğŸ‘¥_è·å“¡ç®¡ç†.py             (æ›´æ–°)
  â”œâ”€â”€ 2_â°_æ™‚é–“å¸¯è¨­å®š.py           (å‰Šé™¤)
  â”œâ”€â”€ 3_ğŸ–ï¸_ä¼‘æš‡ç®¡ç†.py            (æ–°è¦ãƒ»æ—§3_ğŸ“…ã‹ã‚‰æ”¹å)
  â”œâ”€â”€ 4_ğŸ¯_ã‚·ãƒ•ãƒˆç”Ÿæˆ.py          (ç•ªå·å¤‰æ›´)
  â””â”€â”€ 5_ğŸ“‹_ã‚·ãƒ•ãƒˆè¡¨ç¤º.py          (ç•ªå·å¤‰æ›´)

scripts/
  â”œâ”€â”€ migrate_to_v3.py             (æ–°è¦)
  â”œâ”€â”€ init_v3_sample_data.py       (æ–°è¦)
  â””â”€â”€ ...

tests/
  â”œâ”€â”€ test_availability_v3.py      (æ–°è¦)
  â””â”€â”€ ...

docs/
  â”œâ”€â”€ REQUIREMENTS_V3.md           (æ–°è¦)
  â”œâ”€â”€ IMPLEMENTATION_PLAN_V3.md    (æœ¬ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ)
  â”œâ”€â”€ MIGRATION_GUIDE_V2_TO_V3.md  (æ–°è¦)
  â””â”€â”€ ...
```

### 7.2 ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒï¼ˆV3.0æœ€çµ‚å½¢ï¼‰

```sql
-- å‹¤å‹™å½¢æ…‹ãƒã‚¹ã‚¿
CREATE TABLE employment_patterns (
    id TEXT PRIMARY KEY,
    name TEXT NOT NULL,
    category TEXT NOT NULL,
    start_time TEXT NOT NULL,
    end_time TEXT NOT NULL,
    break_hours REAL NOT NULL,
    work_hours REAL NOT NULL,
    can_work_afternoon BOOLEAN DEFAULT 1,
    description TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- æ™‚é–“å¸¯ãƒã‚¹ã‚¿ï¼ˆå›ºå®šï¼‰
CREATE TABLE time_slots (
    id TEXT PRIMARY KEY,
    day_of_week INTEGER NOT NULL,
    period TEXT NOT NULL,
    start_time TEXT NOT NULL,
    end_time TEXT NOT NULL,
    is_active BOOLEAN DEFAULT 1,
    required_staff INTEGER DEFAULT 2,
    area TEXT DEFAULT 'å—ä»˜',
    display_name TEXT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ä¼‘æš‡ç™»éŒ²
CREATE TABLE employee_absences (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    employee_id INTEGER NOT NULL,
    absence_date DATE NOT NULL,
    absence_type TEXT NOT NULL,
    reason TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (employee_id) REFERENCES employees(id) ON DELETE CASCADE,
    UNIQUE(employee_id, absence_date, absence_type)
);

-- è·å“¡ãƒã‚¹ã‚¿ï¼ˆæ‹¡å¼µï¼‰
ALTER TABLE employees ADD COLUMN employment_pattern_id TEXT REFERENCES employment_patterns(id);
```

---

**æ–‡æ›¸ç®¡ç†**
- ç‰ˆæ•°: 1.0
- ä½œæˆæ—¥: 2025-11-27
- æœ€çµ‚æ›´æ–°: 2025-11-27
