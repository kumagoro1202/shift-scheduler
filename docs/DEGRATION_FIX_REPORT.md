# V3.0 デグレ修正レポート

**修正日**: 2025年11月28日  
**対象**: シフト作成システム V3.0

---

## 修正内容サマリー

仕様書（REQUIREMENTS.md）に準拠するよう、**リハ室の時間帯が完全に欠落していた問題**を修正しました。

---

## 発見されたデグレ

### ❌ 重大なデグレ: リハ室時間帯の欠落

**問題**: 
- データベースの `time_slots` テーブルに**受付エリアの時間帯のみ**が登録されていた
- **リハ室エリアの時間帯が完全に存在しない**状態だった

**影響**:
- TYPE_C（リハ室のみ・正職員）とTYPE_D（リハ室のみ・パート）の職員が配置不可
- リハ室スキルスコアが活用されない
- 仕様書で定義された業務エリアの半分が機能しない

---

## 実施した修正

### 1. データベーススキーマの修正 (`src/database.py`)

**修正箇所**: `init_fixed_time_slots()` 関数

**変更内容**:
- リハ室の時間帯データを追加（月〜土曜日、各日午前・午後）
- 受付の時間帯も仕様に合わせて調整

**追加されたリハ室時間帯**:
```python
# リハ室（終日：08:30-19:00、必要人数2名）
月曜: リハ室（午前） 08:30-13:00, リハ室（午後） 13:00-19:00
火曜: リハ室（午前） 08:30-13:00, リハ室（午後） 13:00-19:00
水曜: リハ室（午前） 08:30-13:00, リハ室（午後） 13:00-19:00
木曜: リハ室（午前） 08:30-13:00, リハ室（午後） 13:00-19:00
金曜: リハ室（午前） 08:30-13:00, リハ室（午後） 13:00-19:00
土曜: リハ室（午前） 08:30-13:30, リハ室（午後） 13:30-19:00
```

**追加された受付時間帯**:
```python
# 受付（診療時間に合わせて、必要人数: 午前1-2名、午後1名）
月曜: 受付（午前） 08:30-13:00, 受付（午後） 13:00-19:00
火曜: 受付（午前） 08:30-13:00, 受付（午後） 13:00-19:00
水曜: 受付（午前） 08:30-13:00, 受付（午後） 13:00-18:00
木曜: 受付（午前） 08:30-13:00
金曜: 受付（午前） 08:30-13:00, 受付（午後） 13:00-19:00
土曜: 受付（午前） 08:30-13:30
```

### 2. データベース取得関数の改善

**修正箇所**: `get_all_time_slots()`, `get_time_slot_by_id()` 関数

**変更内容**:
- データベースの `area` カラムを `area_type` フィールドとしてもマッピング
- `period` カラムを日本語の `time_period` フィールドに変換
  - `morning` → `午前`
  - `afternoon` → `午後`

### 3. スキルスコア計算の修正 (`src/optimizer.py`)

**修正箇所**: `calculate_skill_score()` 関数

**変更内容**:
- 仕様書 § 6.2 に準拠したスキル計算に修正
- **リハ室**: リハ室スキル + 総合対応力
- **受付（午前）**: 受付午前スキル + 総合対応力
- **受付（午後）**: 受付午後スキル + 総合対応力

### 4. 目標スキルスコアの動的計算

**修正箇所**: `calculate_objective_value()` 関数

**変更内容**:
- 目標スキルスコアを「必要人数 × 平均目標スキル（150点/人）」で動的計算
- V3.0仕様ではスキルスコアが最大200点/人（基礎スキル100点 + 総合対応力100点）

### 5. UI表示の改善 (`main.py`)

**追加内容**:
- 業務エリア情報の表示を追加
- リハ室と受付の時間帯数を個別に表示
- 業務エリアごとの配置可能職員タイプを明示

### 6. ドキュメントの更新 (`README.md`)

**追加内容**:
- V3.0業務エリアの詳細説明
- リハ室と受付の営業時間、必要人数、配置可能職員タイプ
- スキル評価方法の明記

---

## 追加ツール

### 時間帯マスタ再初期化スクリプト

**ファイル**: `scripts/reinit_timeslots.py`

**用途**: 既存の時間帯データをV3.0仕様に基づいて再初期化

**使用方法**:
```powershell
python scripts/reinit_timeslots.py
```

---

## 動作確認方法

### 1. 時間帯マスタの再初期化

```powershell
# データベースの時間帯を再初期化
python scripts/reinit_timeslots.py
```

### 2. アプリケーションの起動

```powershell
# Streamlitアプリを起動
streamlit run main.py
```

### 3. 確認項目

- [ ] ホーム画面で「リハ室時間帯」と「受付時間帯」が表示される
- [ ] 業務エリア情報にリハ室と受付の両方が表示される
- [ ] 職員管理でTYPE_C, TYPE_Dの職員を登録できる
- [ ] シフト生成でリハ室の時間帯にも職員が配置される
- [ ] シフト表示でリハ室と受付が区別して表示される

---

## データベースへの影響

**既存シフトデータ**: 影響なし（time_slotsの変更は既存のshiftsレコードに影響しない）

**必要な対応**: 
- 新規にシフトを生成する場合、リハ室の時間帯も含まれるようになります
- 既存のシフトを再生成する場合は、期間を指定して再度シフト生成を実行してください

---

## 仕様との整合性

✅ **診療時間**: 仕様書通り  
✅ **業務エリア**: リハ室と受付の両方を実装  
✅ **職員タイプ**: TYPE_A〜Dすべて機能  
✅ **スキルスコア**: 4項目すべて活用  
✅ **勤務形態**: 6種類すべて実装  
✅ **休暇管理**: 日付単位で実装  
✅ **最適化**: 3モードすべて実装  

---

**修正完了**: すべての機能が仕様書（REQUIREMENTS.md）に準拠するようになりました。
