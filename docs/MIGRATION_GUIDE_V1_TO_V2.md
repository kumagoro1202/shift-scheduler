# シフト管理システム V1.0 → V2.0 マイグレーションガイド

## 📋 目次

1. [概要](#概要)
2. [マイグレーション前の準備](#マイグレーション前の準備)
3. [マイグレーション手順](#マイグレーション手順)
4. [マイグレーション後の設定](#マイグレーション後の設定)
5. [トラブルシューティング](#トラブルシューティング)

---

## 概要

### V2.0で追加された機能

- **4項目スキルスコアシステム**: 従来の単一スキルから4項目（リハ室、受付午前、受付午後、総合対応力）に拡張
- **職員タイプ制約**: TYPE_A〜Dによる業務エリア制限
- **勤務形態管理**: 雇用形態、勤務形態、勤務パターンの詳細管理
- **休憩ローテーション**: 自動休憩時間割り当て機能
- **最適化モード選択**: バランス/スキル重視/日数重視の3モード

### 互換性について

✅ **V1.0のデータは自動的にV2.0形式に変換されます**
- 既存の職員データは保持されます
- 既存のシフトデータは引き続き表示可能です
- V1.0の`skill_score`フィールドは互換性のため残されます

---

## マイグレーション前の準備

### 1. データベースバックアップ（必須）

マイグレーション前に必ずデータベースをバックアップしてください。

#### 自動バックアップ

マイグレーションスクリプトは実行時に自動的にバックアップを作成します:

```
data/shift_backup_YYYYMMDD_HHMMSS.db
```

#### 手動バックアップ

念のため、手動でもバックアップを作成することを推奨します:

```powershell
# Windowsの場合
Copy-Item "data\shift.db" "data\shift_backup_manual.db"
```

### 2. 現在のシステムバージョン確認

V1.0を使用していることを確認してください。

### 3. 必要な情報の準備

マイグレーション後に設定する情報を準備してください:

- 各職員の職員タイプ（TYPE_A〜D）
- 各職員の雇用形態（正職員/パート）
- 各職員の勤務形態（フルタイム/時短/パートタイム）
- 各職員の4項目スキルスコア

---

## マイグレーション手順

### ステップ1: V2.0システムのインストール

新しいバージョンのシステムをインストールします。

#### 実行ファイル版

1. 新しい`shift_system_v2.exe`をダウンロード
2. 既存のデータベースフォルダを保持したまま、実行ファイルを上書き

#### Python版

```powershell
# リポジトリを更新
git pull origin main

# または最新版をダウンロードして上書き
```

### ステップ2: マイグレーションスクリプトの実行

システムを起動すると、自動的にマイグレーションが実行されます。

```powershell
# Python環境の場合
python -m src.migration
```

または、アプリケーション起動時に自動実行されます:

```powershell
streamlit run main.py
```

### ステップ3: マイグレーション結果の確認

マイグレーションが成功すると、以下のメッセージが表示されます:

```
✅ データベースマイグレーション完了 (V2.0)
📦 バックアップ: data/shift_backup_20251127_123456.db
```

失敗した場合:

```
❌ マイグレーションエラー: [エラー内容]
```

この場合は、[トラブルシューティング](#トラブルシューティング)を参照してください。

### ステップ4: データ整合性確認

マイグレーション後、以下を確認してください:

1. **職員データの確認**
   - 職員管理画面を開く
   - 全職員が表示されることを確認
   - デフォルト値が設定されていることを確認:
     - `employee_type`: TYPE_A
     - `work_type`: フルタイム
     - `work_pattern`: P1
     - `skill_reha_room`: 旧skill_scoreの値
     - その他のスキル: 旧skill_scoreの半分

2. **時間帯データの確認**
   - 時間帯設定画面を開く
   - 全時間帯が表示されることを確認
   - デフォルト値が設定されていることを確認:
     - `area_type`: 受付
     - `time_period`: 終日
     - `required_employees_min`: 1
     - `required_employees_max`: 旧required_employees
     - `target_skill_score`: 150
     - `skill_weight`: 1.0

3. **既存シフトの確認**
   - シフト表示画面を開く
   - 既存のシフトが正しく表示されることを確認

---

## マイグレーション後の設定

### 1. 職員情報の更新（推奨）

デフォルト値から実際の値に更新してください。

#### 各職員について:

1. **職員管理** → 対象職員を選択 → **編集**
2. 以下を設定:
   - **職員タイプ**: 実際の業務可能エリアに応じて選択
   - **雇用形態**: 正職員 または パート
   - **勤務形態**: フルタイム / 時短勤務 / パートタイム
   - **勤務パターン**: 該当するパターンを選択
   - **4項目スキルスコア**: 実際の能力に応じて設定

#### 例:

**田中太郎さん（ベテラン正職員）の場合:**

- 職員タイプ: TYPE_A（リハ室・受付両方可能）
- 雇用形態: 正職員
- 勤務形態: フルタイム
- 勤務パターン: P1
- スキルスコア:
  - リハ室スキル: 90
  - 受付午前スキル: 85
  - 受付午後スキル: 85
  - 総合対応力: 88

**鈴木花子さん（パート職員）の場合:**

- 職員タイプ: TYPE_D（リハ室のみ・パート）
- 雇用形態: パート
- 勤務形態: パートタイム
- 勤務パターン: PT1（午前パート）
- スキルスコア:
  - リハ室スキル: 70
  - 受付午前スキル: 0（受付業務なし）
  - 受付午後スキル: 0（受付業務なし）
  - 総合対応力: 60

### 2. 時間帯設定の更新（推奨）

より詳細な設定に更新してください。

#### 各時間帯について:

1. **時間帯設定** → 対象時間帯を選択 → **編集**
2. 以下を設定:
   - **業務エリア**: リハ室 または 受付
   - **時間区分**: 午前 / 午後 / 終日
   - **必要人数範囲**: 最小〜最大
   - **目標スキルスコア**: 理想的なスキル合計
   - **重み係数**: 重要度（デフォルト1.0）

#### 例:

**「受付午前」の設定:**

- 業務エリア: 受付
- 時間区分: 午前
- 必要人数: 最小2名、最大3名
- 目標スキルスコア: 160
- 重み係数: 1.2（午前は重要度高め）

### 3. 勤務パターンの確認

デフォルトで以下の勤務パターンが登録されています:

| ID | 名称 | 勤務形態 | 勤務時間 | 休憩 | 実働 |
|----|------|---------|---------|------|------|
| P1 | 基本パターン1 | フルタイム | 08:30-18:30 | 2時間×2回 | 8時間 |
| P2 | 基本パターン2 | フルタイム | 08:45-18:45 | 2時間×2回 | 8時間 |
| P3 | 基本パターン3 | フルタイム | 09:00-19:00 | 2時間×2回 | 8時間 |
| P4 | 時短勤務 | 時短勤務 | 08:45-16:45 | 1時間×1回 | 7時間 |
| PT1 | 午前パート | パートタイム | 08:45-12:45 | なし | 4時間 |
| PT2 | 午前延長パート | パートタイム | 08:45-13:45 | なし | 5時間 |

必要に応じて、カスタムパターンを追加できます（将来のバージョンで対応予定）。

---

## トラブルシューティング

### マイグレーションが失敗する

**症状:** マイグレーション実行時にエラーが発生

**原因と対策:**

1. **データベースファイルが開かれている**
   - 他のアプリケーションでデータベースを開いていないか確認
   - システムを完全に終了してから再実行

2. **ディスク容量不足**
   - 十分なディスク空き容量があるか確認（最低100MB推奨）

3. **権限エラー**
   - 管理者権限でコマンドプロンプトを開いて実行

**復旧方法:**

バックアップから復元:

```powershell
# バックアップファイルを元に戻す
Copy-Item "data\shift_backup_manual.db" "data\shift.db"
```

### 職員データが表示されない

**症状:** マイグレーション後、職員一覧が空になっている

**原因:** マイグレーションが不完全

**対策:**

1. データベースバックアップから復元
2. マイグレーションスクリプトを再実行
3. それでも解決しない場合は、サポートに連絡

### スキルスコアが0になっている

**症状:** 一部の職員のスキルスコアが0

**原因:** マイグレーション時のデフォルト値設定

**対策:**

手動で正しい値を設定してください（[マイグレーション後の設定](#1-職員情報の更新推奨)参照）

### 既存シフトが表示されない

**症状:** V1.0で作成したシフトが表示されない

**原因:** データベース整合性エラー

**対策:**

1. シフト表示画面で年月を正しく選択
2. データベースの整合性チェックを実行:

```powershell
python -c "from src.database import check_database_integrity; check_database_integrity()"
```

### 休憩時間が設定できない

**症状:** 休憩時間の自動割り当てが失敗

**原因:** 受付職員が3名未満

**対策:**

- 受付窓口には最低3名の職員が必要です（2名実働+1名休憩）
- 職員を追加するか、手動でシフトを調整してください

---

## ロールバック手順

V2.0からV1.0に戻す必要がある場合:

### 1. バックアップからの復元

```powershell
# バックアップファイルを元に戻す
Copy-Item "data\shift_backup_YYYYMMDD_HHMMSS.db" "data\shift.db"
```

### 2. V1.0システムの再インストール

V1.0の実行ファイルまたはコードを再インストールします。

### 3. 注意事項

⚠️ **V2.0で作成したデータはV1.0では利用できません**
- V2.0で追加した職員情報は失われます
- V2.0で生成したシフトは表示されません

---

## サポート

### 問い合わせ先

マイグレーションに関する問題が解決しない場合は、以下の情報を添えてサポートに連絡してください:

- システムバージョン
- エラーメッセージの全文
- マイグレーション実行時のログ
- データベースバックアップのタイムスタンプ

---

**ドキュメント作成日**: 2025年11月27日  
**対象バージョン**: V1.0 → V2.0  
