# シフト管理システム 利用ガイド

## 📋 目次

1. [はじめに](#はじめに)
2. [システム起動](#システム起動)
3. [主な機能](#features)
4. [基本的な使い方](#基本的な使い方)
5. [機能詳細](#機能詳細)
6. [トラブルシューティング](#トラブルシューティング)

---

## はじめに

### システム概要

このシステムは、小規模施設（5〜10名程度）向けのシフト管理システムです。
本システムでは診療時間の固定化と日付単位の休暇管理により、より簡単で効率的な運用が可能になりました。

### 主な機能

- ✅ 職員情報管理（職員タイプ、4項目スキルスコア、勤務形態）
- ✅ 日付単位の休暇管理（運用の簡素化）
- ✅ 診療時間の固定化（システム定義）
- ✅ 自動シフト最適化（3つの最適化モード）
- ✅ 休憩時間自動割り当て
- ✅ シフト表示・編集
- ✅ Excel出力

### 必要な環境

- **OS**: Windows 10/11（実行可能ファイル版）
- **ブラウザ**: Chrome, Edge, Firefox など

---

<a id="features"></a>
## 主な機能

### 1. 診療時間の固定化

診療時間がシステムで固定され、設定不要になりました。

| 曜日 | 午前診療 | 午後診療 | 備考 |
|------|---------|---------|------|
| 月曜 | 09:00-12:30 | 15:30-18:30 | 通常診療 |
| 火曜 | 09:00-12:30 | 15:30-18:30 | 通常診療 |
| 水曜 | 09:00-12:30 | 15:30-17:30 | 午後は1時間短縮 |
| 木曜 | 09:00-12:30 | 休診 | 午前のみ |
| 金曜 | 09:00-12:30 | 15:30-18:30 | 通常診療 |
| 土曜 | 09:00-13:30 | 休診 | 午前のみ（延長） |
| 日曜 | 休診 | 休診 | 定休日 |

### 2. 日付単位の休暇管理

本システムでは、休暇登録が日付単位で可能になり、運用が大幅に簡素化されました。

#### 休暇種別

- **終日休暇**: 1日全体の休暇
- **午前休**: 午前のみの休暇
- **午後休**: 午後のみの休暇

#### 自動判定

休暇登録のない日は、職員の勤務形態に応じて自動的に勤務可能と判定されます。

### 3. 4項目スキルスコアシステム

各職員は以下の4項目のスキルスコアを持ちます（0〜100点）。

- **リハ室スキル**: リハビリ室での業務能力
- **受付午前スキル**: 受付業務（午前）の能力
- **受付午後スキル**: 受付業務（午後）の能力
- **総合対応力**: 全般的な対応能力

### 4. 職員タイプ制約

- **TYPE_A**: リハ室・受付両方可能（最も柔軟）
- **TYPE_B**: 受付のみ（正職員・パート共通）
- **TYPE_C**: リハ室のみ（正職員）
- **TYPE_D**: リハ室のみ（パート）
- **TYPE_E**: 受付のみ（パート）
- **TYPE_F**: 受付のみ（時短）

### 5. 勤務形態管理

- **雇用形態**: 正職員 / パート
- **勤務形態**: フルタイム（早番/中番/遅番）/ 時短勤務 / パートタイム
- **自動判定**: 勤務形態から勤務可能な時間帯を自動判定

### 6. 休憩ローテーション機能

- **正職員B/C（月火金）と通常/△（水曜）**: 基本的に2時間連続で休憩取得（忙しい日は分割可）
- **正職員A（月火金）と○（水曜）**: 1時間×1回の休憩
- **時短勤務**: 1時間×1回の休憩
- **パート（午後まで）**: 1時間×1回の休憩
- **パート午前・木土勤務**: 休憩なし
- **受付窓口には常に必要な人数が実働（午前4-5名、午後3名）**

**緊急時の休憩短縮対応**:
- 欠勤者が出た場合、休憩時間を1時間（60分）に短縮可能
- 短縮した1時間分は残業時間として計上
- これにより休憩返上（サービス残業）を防止

### 7. 最適化モード選択

- **バランス**: 勤務回数とスキルの両方を考慮（推奨）
- **スキル重視**: 目標スキルスコアへの近似を優先
- **日数重視**: 勤務回数の均等化を優先

---

## システム起動

### 方法1: 実行可能ファイル版（推奨）

1. `shift_system.exe` をダブルクリック
2. 自動的にブラウザが起動します
3. ブラウザに管理画面が表示されます

> **注意**: 初回起動時は、Windowsのセキュリティ警告が表示される場合があります。
> 「詳細情報」→「実行」をクリックしてください。

### 方法2: Python環境から起動

```powershell
# 依存関係のインストール（初回のみ）
pip install -r requirements.txt

# アプリケーション起動
streamlit run main.py
```

### 終了方法

- **実行ファイル版**: ブラウザを閉じた後、コマンドプロンプトウィンドウで `Ctrl+C`
- **Python版**: ターミナルで `Ctrl+C`

---

## 基本的な使い方

### 初期セットアップ（初回のみ）

#### ステップ1: サンプルデータの投入（オプション）

テスト用のサンプルデータを使う場合:

```powershell
python init_sample_data.py
```

これにより以下が自動登録されます:
- 5名の職員（スキルスコア 70-90）
- 4つの時間帯（早番、日勤、遅番、夜勤）
- 今月と来月の勤務可能情報

#### ステップ2: 職員登録（V2.0対応）

1. 左サイドバーから「👥 職員管理」をクリック
2. 「新規登録」タブを選択
3. 以下を入力:
   - 氏名（例: 田中 太郎）
   - 雇用形態: 正職員 または パート
   - 職員タイプ: TYPE_A～TYPE_F（業務可能エリアを選択）
     - TYPE_A: リハ室・受付両方可能
     - TYPE_B: 受付専任（正職員・パート共通）
     - TYPE_C: リハ室専任（正職員）
     - TYPE_D: リハ室専任（パート）
     - TYPE_E: 受付専任（パート）
     - TYPE_F: 受付専任（時短）
   - 勤務形態: フルタイム / 時短勤務 / パートタイム
   - 勤務パターン: P1～P3, P4, PT1～PT2から選択
   - **4項目スキルスコア**（各0-100）:
     - リハ室スキル
     - 受付午前スキル（医事業務能力を優先評価）
     - 受付午後スキル（医事業務能力を優先評価）
     - 総合対応力
4. 「登録」ボタンをクリック

**職員タイプの選択:**

- **TYPE_A（リハ室・受付両方可能）**: 最も柔軟な配置が可能
- **TYPE_B（受付のみ）**: 受付業務専任（正職員・パート共通）
- **TYPE_C（リハ室のみ・正職員）**: リハビリ業務専任
- **TYPE_D（リハ室のみ・パート）**: パート職員で特殊ルールが適用
- **TYPE_E（受付のみ・パート）**: 受付業務専任のパート職員
- **TYPE_F（受付のみ・時短）**: 受付業務専任の時短勤務

**スキルスコアの目安:**

- 100: エキスパート
- 80-90: ベテラン
- 60-79: 中堅
- 40-59: 新人
- 1-39: 研修中

#### ステップ3: 時間帯設定（V2.0対応）

1. 左サイドバーから「⏰ 時間帯設定」をクリック
2. 「新規登録」タブを選択
3. 以下を入力:
   - 時間帯名（例: 受付午前）
   - **業務エリア**: リハ室 または 受付
   - **時間区分**: 午前 / 午後 / 終日
   - 開始時刻（例: 08:30）
   - 終了時刻（例: 12:30）
   - **必要人数範囲**: 最小〜最大（例: 2〜3名）
   - **目標スキルスコア**: この時間帯の理想的なスキル合計（例: 150）
   - **重み係数**: 重要度（0.1〜5.0、デフォルト1.0）
4. 「登録」ボタンをクリック

**時間帯設定例:**

| 時間帯名 | エリア | 時間区分 | 開始 | 終了 | 必要人数 | 目標スキル |
|---------|--------|---------|------|------|---------|----------|
| 受付午前 | 受付 | 午前 | 08:30 | 12:30 | 2-3 | 150 |
| 受付午後 | 受付 | 午後 | 13:30 | 18:30 | 2-3 | 150 |
| リハ室午前 | リハ室 | 午前 | 08:30 | 12:30 | 1-2 | 120 |
| リハ室午後 | リハ室 | 午後 | 13:30 | 18:30 | 1-2 | 120 |

#### ステップ3: 休暇の登録

1. 左サイドバーから「🏖️ 休暇管理」をクリック
2. 年月を選択
3. 職員を選択
4. カレンダーで休暇を取る日付をクリック
5. 休暇種別を選択（終日休暇/午前休/午後休）
6. 保存ボタンをクリック

**簡素化ポイント:**
- 休暇を取る日付のみ登録
- 休暇登録のない日は、勤務形態に応じて自動的に勤務可能
- 時間帯ごとの細かい設定は不要

---

## 機能詳細

### 1. 職員管理（👥）

#### 職員一覧

- 登録済み職員の一覧表示
- 4項目スキルスコアを視覚的に確認（プログレスバー）
- 職員タイプと勤務形態を表示

#### 新規登録

1. 「新規職員登録」セクションに移動
2. 基本情報を入力:
   - 氏名
   - 職員タイプ（TYPE_A〜D）
   - 雇用形態（正職員/パート）
   - 勤務形態（プルダウンから選択）

3. スキルスコアを入力（各0〜100点）:
   - リハ室スキル
   - 受付午前スキル
   - 受付午後スキル
   - 総合対応力

4. 「登録」ボタンをクリック

#### 編集

1. 編集したい職員を選択
2. 項目を修正
3. 「更新」ボタンをクリック

#### 削除

1. 削除したい職員を選択
2. 「削除」ボタンをクリック
3. 確認ダイアログで「OK」

> **注意**: 職員を削除すると、その職員の休暇情報やシフトも削除されます

### 2. 診療時間の確認（ホーム画面）

本システムでは診療時間が固定されているため、設定画面は不要です。
ホーム画面で診療時間一覧を確認できます。

| 曜日 | 午前診療 | 午後診療 |
|------|---------|---------|
| 月曜 | 09:00-12:30 | 15:30-18:30 |
| 火曜 | 09:00-12:30 | 15:30-18:30 |
| 水曜 | 09:00-12:30 | 15:30-17:30 |
| 木曜 | 09:00-12:30 | 休診 |
| 金曜 | 09:00-12:30 | 15:30-18:30 |
| 土曜 | 09:00-13:30 | 休診 |
| 日曜 | 休診 | 休診 |

### 3. 休暇管理（🏖️）

#### カレンダー表示

- 月単位でのカレンダー表示
- 休暇種別ごとに色分け表示
  - 🏖️ 終日休暇
  - 🌅 午前休
  - 🌆 午後休

#### 休暇登録

1. カレンダーで日付をクリック
2. 休暇種別を選択
3. 理由を入力（任意）
4. 「登録」ボタンをクリック

#### 休暇削除

1. 削除したい休暇をリストから選択
2. 「削除」ボタンをクリック

#### 自動判定の仕組み

```text
休暇登録なし → 勤務形態に応じて自動的に勤務可能
終日休暇     → その日の全時間帯が勤務不可
午前休       → 午前の時間帯のみ勤務不可
午後休       → 午後の時間帯のみ勤務不可
```

### 3.5 勤務形態の詳細（記号表記）

勤務表（CSV）で使用される記号の意味：

#### 月火金の記号

| 記号 | 意味 | 勤務時間 | 休憩 |
|------|------|---------|------|
| A | 早出 | 08:30-17:30 | 60分 |
| B | 通常 | 08:45-18:45 | 120分（基本2時間連続） |
| C | 遅出 | 09:15-19:15 | 120分（基本2時間連続） |

#### 水曜日の記号

| 記号 | 意味 | 勤務時間 | 休憩 |
|------|------|---------|------|
| ◯ | 早出 | 08:30-16:30 | 60分 |
| 通常 | 通常 | 08:45-17:45 | 120分（基本2時間連続） |
| △ | 遅出 | 09:15-18:15 | 120分（基本2時間連続） |

#### 木曜日・土曜日の記号

| 記号 | 意味 | 勤務時間 | 休憩 |
|------|------|---------|------|
| 1 | 早出 | 08:30-12:30 | なし |
| 2 | 通常 | 08:45-12:45 | なし |
| 3 | 遅出 | 09:00-13:00 | なし |

#### その他の記号

| 記号 | 意味 | 備考 |
|------|------|------|
| PA | パート午前（4時間） | 08:45-12:45 または 09:00-13:00 |
| P3 | パート午後まで | 08:45-16:45（60分休憩、時短に準ずる） |
| 月火 | 時短勤務（月火） | 08:45-16:45（60分休憩） |
| 早 | 時短勤務（早出） | 08:45-16:45（60分休憩） |
| 土曜 | 時短勤務（土） | 09:45-13:45 |
| 有休 | 有給休暇 | 終日休暇 |
| 休み | 休暇 | 終日休暇 |

**重要**: 正職員の休憩時間は基本的に2時間連続で取得しますが、忙しい日は分割することもあります（当日の判断）。

### 4. シフト生成（🎯）

#### 生成手順

1. 対象期間を選択
   - **月単位**: 年月を選択（当月20日〜翌月20日の範囲）
   - **カスタム**: 開始日と終了日を指定

2. 最適化パラメータを確認
   - スキルバランス重視度（デフォルト: 1.0）
   - タイムアウト時間（デフォルト: 60秒）

3. 「シフトを生成」ボタンをクリック

4. 結果を確認
   - 生成されたシフト数
   - スキルバランススコア
   - 警告やエラーメッセージ

#### 最適化の仕組み

システムは以下を最適化します:
- ✅ 各時間帯の必要人数を満たす
- ✅ 職員の勤務可能日を考慮
- ✅ 1人1日1シフトの制約
- ✅ 各時間帯のスキル合計を均等化

**バランススコアの見方:**
- 10未満: 非常に良好 🌟
- 10-20: 良好 ✨
- 20以上: 要改善 ⚠️

### 5. シフト表示（📋）

#### カレンダー表示

- 月単位で選択した場合は当月20日〜翌月20日を表示
- 日付ごとにシフトを表示
- 各時間帯の担当職員とスキルスコアを確認
- 時間帯ごとのスキル合計・平均を表示

#### シフトの削除

1. カレンダー表示で該当シフトの「🗑️」ボタンをクリック
2. 確認後、削除実行

#### 統計・分析

**職員別勤務日数:**
- 各職員の勤務日数を棒グラフで表示
- 勤務の偏りをチェック

**時間帯別スキル分布:**
- 日別・時間帯別のスキル合計推移
- 時間帯ごとの平均値

**全体統計:**
- 総シフト数
- 平均スキル
- スキル標準偏差
- バランススコア

#### Excelエクスポート

1. 「エクスポート」タブを選択
2. 「Excelファイルとしてエクスポート」ボタンをクリック
3. 「ダウンロード」ボタンでファイル取得

**出力ファイル:**
- ファイル名: `shift_YYYYMM.xlsx`
- 保存場所: `exports/` フォルダ
- 内容: 日付、時間帯、職員名、スキルスコア

---

## ワークフロー例

### 月次シフト作成の流れ

#### 1ヶ月目（初回セットアップ）

1. **職員登録**（5分）
   - 全職員の情報を登録

2. **時間帯設定**（3分）
   - 施設の勤務体系に合わせて設定

3. **勤務可能情報入力**（10分）
   - 来月分の勤務可能日を各職員ごとに入力

4. **シフト生成**（1分）
   - 対象月を選択して生成

5. **確認・調整**（5分）
   - 生成されたシフトを確認
   - 必要に応じて手動調整（削除・再生成）

6. **Excel出力**（1分）
   - 印刷・配布用にエクスポート

**所要時間: 約25分**

#### 2ヶ月目以降（運用フェーズ）

1. **勤務可能情報更新**（5分）
   - 翌月分の勤務可能日を入力

2. **シフト生成**（1分）

3. **確認・調整**（3分）

4. **Excel出力**（1分）

**所要時間: 約10分**

---

## トラブルシューティング

### Q1: シフトが生成できない

**原因と対策:**

❌ **職員が登録されていない**
- → 「職員管理」で職員を登録

❌ **時間帯が設定されていない**
- → 「時間帯設定」で時間帯を追加

❌ **勤務可能情報が不足**

> **注意**: 勤務可能情報を登録していない場合は、自動的に「全日程勤務可能」として扱われます。

- → エラーメッセージで不足している日時を確認
- → 「勤務可能情報」で勤務不可の設定を見直す
- → 必要人数に対して勤務可能な職員が少ない日時がないか確認

❌ **最適化に失敗**

- → 制約が厳しすぎる可能性（勤務不可の設定が多すぎる）
- → 必要人数を減らすか、勤務不可の設定を減らす
- → 職員数を増やす

### Q2: バランススコアが高い（20以上）

**改善方法:**

1. **スキルスコアの見直し**
   - 極端な差がないか確認
   - 適切な範囲（60-90）に調整

2. **勤務可能情報の調整**
   - 高スキル職員の勤務可能日を増やす
   - 低スキル職員の偏りを減らす

3. **時間帯の見直し**
   - 必要人数を調整
   - 時間帯の数を減らす

### Q3: アプリケーションが起動しない

**チェック項目:**

□ ポート8501が使用されていないか確認
  ```powershell
  netstat -ano | findstr :8501
  ```

□ 別のStreamlitアプリが起動していないか

□ ファイアウォール設定を確認

□ `shift.db` ファイルの権限を確認

### Q4: データが消えた

**データの保存場所:**
- データベース: `shift.db`
- Excelファイル: `exports/` フォルダ

**バックアップ方法:**
```powershell
# データベースをバックアップ
Copy-Item shift.db shift_backup_$(Get-Date -Format 'yyyyMMdd').db
```

### Q5: Excel出力ができない

**対処法:**

1. `exports/` フォルダの書き込み権限を確認
2. 同名ファイルが開かれていないか確認
3. エラーメッセージを確認

---

## 便利な Tips

### 💡 Tip 1: 勤務可能情報の効率的な入力

月初に一括設定してから、休み希望日だけ個別に外す方法が効率的です:

1. 「すべて勤務可能にする」をクリック
2. 休み希望日のチェックを外す
3. 保存

### 💡 Tip 2: スキルバランスの調整

生成されたシフトのバランスが悪い場合:

1. 統計・分析タブで偏りを確認
2. 特定の職員に偏っている場合は、その職員のスキルスコアを調整
3. 再度シフト生成

### 💡 Tip 3: 定期的なバックアップ

月末にデータベースをバックアップする習慣をつけましょう:

```powershell
# バックアップスクリプト例
Copy-Item shift.db "backup\shift_$(Get-Date -Format 'yyyy年MM月').db"
```

### 💡 Tip 4: 複数月の一括生成

複数月分を一度に生成したい場合:

1. 勤務可能情報を複数月分入力
2. シフト生成でカスタム期間を選択
3. 長期間を指定して生成

### 💡 Tip 5: ブラウザのブックマーク

頻繁に使うページをブックマーク:
- `http://localhost:8501` (ホーム)
- `http://localhost:8501/職員管理`
- `http://localhost:8501/シフト生成`

---

## サポート情報

### システム要件

- **OS**: Windows 10/11
- **メモリ**: 2GB以上推奨
- **ディスク**: 100MB以上の空き容量
- **ブラウザ**: 最新版のChrome/Edge/Firefox

### データ仕様

- **データベース**: SQLite 3.x
- **文字エンコーディング**: UTF-8
- **日付形式**: YYYY-MM-DD
- **時刻形式**: HH:MM (24時間表記)

### ファイル構成

```
shift_system/
├── shift_system.exe      # 実行ファイル
├── shift.db              # データベース（自動生成）
├── exports/              # Excel出力先
│   └── shift_YYYYMM.xlsx
└── USER_GUIDE.md         # 本ガイド
```

---

## 更新履歴

### Version 0.0.3 (2025-12-22)

- ✨ 初回リリース
- 職員管理機能
- 時間帯設定機能
- 勤務可能情報管理
- シフト自動最適化
- シフト表示・編集
- Excel出力機能

---

## お問い合わせ

システムに関するご質問やご要望がございましたら、
システム管理者までお問い合わせください。

**良いシフト作成を！** ✨
